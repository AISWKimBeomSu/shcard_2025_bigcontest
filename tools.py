"""
AI ë¹„ë°€ìƒë‹´ì‚¬ ë¶„ì„ ë„êµ¬ ëª¨ìŒ
3ê°œì˜ ë…ë¦½ì ì¸ ë¶„ì„ ëª¨ë¸ì„ LangChain Toolë¡œ ë¦¬íŒ©í† ë§
"""

import pandas as pd
import numpy as np
import requests
import json
import os
from typing import Dict, Any, List, Tuple
import google.generativeai as genai
from langchain_core.tools import tool

# =============================================================================
# ê³µí†µ ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ë“¤
# =============================================================================

def call_gemini_llm(prompt: str) -> str:
    """Gemini 2.5 Flash LLMì„ í˜¸ì¶œí•˜ì—¬ ì‘ë‹µì„ ë°˜í™˜í•˜ëŠ” í•¨ìˆ˜"""
    try:
        # API í‚¤ ì„¤ì •
        api_key = os.getenv('GOOGLE_API_KEY')
        if not api_key:
            return "ğŸš¨ ì˜¤ë¥˜: Google API í‚¤ê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤."
        
        genai.configure(api_key=api_key)
        model = genai.GenerativeModel('gemini-2.0-flash-exp')
        
        response = model.generate_content(prompt)
        return response.text
        
    except Exception as e:
        return f"ğŸš¨ LLM í˜¸ì¶œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: {str(e)}"

def get_score_from_raw(tier_string):
    """
    '1_10%ì´í•˜' ë˜ëŠ” '6_90%ì´ˆê³¼' ê°™ì€ êµ¬ê°„(tier) ë¬¸ìì—´ì—ì„œ 
    ì•ì˜ ìˆ«ì(1~6)ë¥¼ ì¶”ì¶œí•˜ì—¬ ë°˜í™˜í•©ë‹ˆë‹¤. 
    ì´ ìˆ«ìëŠ” 'ë‚®ì„ìˆ˜ë¡ ì¢‹ìŒ'ì„ ì˜ë¯¸í•©ë‹ˆë‹¤. 
    """
    if pd.isna(tier_string):
        return np.nan
    try:
        # '1_10%ì´í•˜' -> '1' -> 1
        score = int(str(tier_string).split('_')[0])
        return score
    except (ValueError, IndexError, TypeError):
        # ì˜ˆì™¸ ë°œìƒ ì‹œ (e.g., 'N/A' ë˜ëŠ” ì˜ëª»ëœ í˜•ì‹)
        return np.nan

def translate_metric(metric_type, raw_value):
    """ì§€í‘œë¥¼ ì‚¬ëŒì´ ì´í•´í•˜ê¸° ì‰¬ìš´ í…ìŠ¤íŠ¸ë¡œ ë³€í™˜"""
    if pd.isna(raw_value):
        return "ì •ë³´ ì—†ìŒ"
    translation_map = {
        "tenure": {"10%ì´í•˜": "ìƒìœ„ 10% ì´ë‚´ (ê°€ì¥ ì˜¤ë˜ ìš´ì˜)", "10-25%": "ìƒìœ„ 10-25%", "25-50%": "ì¤‘ìƒìœ„ 25-50%", "50-75%": "ì¤‘í•˜ìœ„ 50-75%", "75-90%": "í•˜ìœ„ 10-25%", "90%ì´ˆê³¼": "í•˜ìœ„ 10% ì´ë‚´ (ê°€ì¥ ìµœê·¼ ì‹œì‘)"},
        "level": {"10%ì´í•˜": "ìƒìœ„ 10% ì´ë‚´ (ê°€ì¥ ë†’ìŒ)", "10-25%": "ìƒìœ„ 10-25%", "25-50%": "ì¤‘ìƒìœ„ 25-50%", "50-75%": "ì¤‘í•˜ìœ„ 50-75%", "75-90%": "í•˜ìœ„ 10-25%", "90%ì´ˆê³¼": "í•˜ìœ„ 10% ì´ë‚´ (ê°€ì¥ ë‚®ìŒ)"}
    }
    explanation_map = translation_map.get(metric_type, {})
    for key, explanation in explanation_map.items():
        if key in str(raw_value):
            return f"{raw_value} ({explanation})"
    return str(raw_value)

def score_to_level_text(score):
    """ì ìˆ˜ë¥¼ ë ˆë²¨ í…ìŠ¤íŠ¸ë¡œ ë³€í™˜"""
    if pd.isna(score):
        return "ì •ë³´ ì—†ìŒ"
    if score >= 5.5:
        return "ìµœìƒìœ„ 10% ìˆ˜ì¤€"
    if score >= 4.5:
        return "ìƒìœ„ 10-25% ìˆ˜ì¤€"
    if score >= 3.5:
        return "ì¤‘ìƒìœ„ 25-50% ìˆ˜ì¤€"
    if score >= 2.5:
        return "ì¤‘í•˜ìœ„ 50-75% ìˆ˜ì¤€"
    if score >= 1.5:
        return "í•˜ìœ„ 10-25% ìˆ˜ì¤€"
    return "í•˜ìœ„ 10% ìˆ˜ì¤€"

def _get_store_basic_info(store_id: str, df_all_join: pd.DataFrame) -> tuple[str, pd.Series | None]:
    """
    ê°€ë§¹ì  IDë¡œ ê¸°ë³¸ ì •ë³´ë¥¼ ì¡°íšŒí•˜ê³ , í¬ë§·íŒ…ëœ ë¦¬í¬íŠ¸ì™€ ë°ì´í„° Seriesë¥¼ ë°˜í™˜í•˜ëŠ” ë‚´ë¶€ í—¬í¼ í•¨ìˆ˜.
    ê°€ë§¹ì ì„ ì°¾ì§€ ëª»í•˜ë©´ ì˜¤ë¥˜ ë©”ì‹œì§€ì™€ Noneì„ ë°˜í™˜í•œë‹¤.
    """
    store_data = df_all_join[df_all_join['ENCODED_MCT'] == store_id]
    
    if store_data.empty:
        error_report = f"""
======================================================================
      ğŸš¨ ë¶„ì„ ì‹œì‘ ë¶ˆê°€ - ê°€ë§¹ì  ì •ë³´ ì—†ìŒ
======================================================================

'({store_id})'ì— í•´ë‹¹í•˜ëŠ” ê°€ë§¹ì  ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.
ê°€ê²Œ IDë¥¼ ë‹¤ì‹œ í™•ì¸í•´ì£¼ì„¸ìš”.

"""
        return error_report, None

    latest_result = store_data.sort_values(by='TA_YM', ascending=False).iloc[0]
    
    # ê¸°ë³¸ ì •ë³´ ì¶”ì¶œ
    store_name = latest_result.get('MCT_NM', 'ì •ë³´ ì—†ìŒ')
    industry = latest_result.get('ì—…ì¢…_ì •ê·œí™”2_ëŒ€ë¶„ë¥˜', 'ì •ë³´ ì—†ìŒ')
    commercial_area = latest_result.get('HPSN_MCT_BZN_CD_NM', 'ë¹„ìƒê¶Œ')
    operation_period = latest_result.get('MCT_OPE_MS_CN', 'ì •ë³´ ì—†ìŒ')
    latest_month = latest_result.get('TA_YM', 'ì •ë³´ ì—†ìŒ')
    
    # ë§¤ì¶œ ê´€ë ¨ ì •ë³´
    revenue_level = latest_result.get('RC_M1_SAA', 'ì •ë³´ ì—†ìŒ')
    customer_count_level = latest_result.get('RC_M1_UE_CUS_CN', 'ì •ë³´ ì—†ìŒ')
    avg_amount_level = latest_result.get('RC_M1_AV_NP_AT', 'ì •ë³´ ì—†ìŒ')
    
    # ê³ ê° ë¹„ìœ¨ ì •ë³´
    new_customer_ratio = latest_result.get('MCT_UE_CLN_NEW_RAT', 0)
    revisit_ratio = latest_result.get('MCT_UE_CLN_REU_RAT', 0)
    resident_ratio = latest_result.get('RC_M1_SHC_RSD_UE_CLN_RAT', 0)
    delivery_ratio = latest_result.get('DLV_SAA_RAT', 0)
    
    # ê¸°ë³¸ ì •ë³´ 'ë‚´ìš©' ìƒì„± (í—¤ë” ì œì™¸)
    basic_info_content = f"""
### ğŸ“‹ ê¸°ë³¸ ì •ë³´
- **ê°€ë§¹ì ëª…:** {store_name}
- **ì—…ì¢…:** {industry}
- **ìƒê¶Œ:** {commercial_area if pd.notna(commercial_area) else 'ë¹„ìƒê¶Œ'}
- **ìš´ì˜ ê¸°ê°„:** {operation_period}
- **ìµœì‹  ë°ì´í„°:** {latest_month}

### ğŸ’° ë§¤ì¶œ í˜„í™© (ìµœì‹ ì›” ê¸°ì¤€)
- **ë§¤ì¶œ ìˆ˜ì¤€:** {revenue_level}
- **ë°©ë¬¸ ê³ ê° ìˆ˜:** {customer_count_level}
- **ê°ë‹¨ê°€ ìˆ˜ì¤€:** {avg_amount_level}

### ğŸ‘¥ ê³ ê° ë¶„ì„ (ìµœì‹ ì›” ê¸°ì¤€)
- **ì‹ ê·œ ê³ ê° ë¹„ìœ¨:** {new_customer_ratio:.1f}%
- **ì¬ë°©ë¬¸ ê³ ê° ë¹„ìœ¨:** {revisit_ratio:.1f}%
- **ê±°ì£¼ ê³ ê° ë¹„ìœ¨:** {resident_ratio:.1f}%
- **ë°°ë‹¬ ë§¤ì¶œ ë¹„ìœ¨:** {delivery_ratio:.1f}%

---
""" # êµ¬ë¶„ì„ ìœ„í•´ ê°€ë¡œì„ ì„ ì¶”ê°€í•©ë‹ˆë‹¤.
    return basic_info_content, latest_result

# =============================================================================
# ëª¨ë¸ 1: ì¹´í˜ ì—…ì¢… ì£¼ìš” ê³ ê° ë¶„ì„ ë° ë§ˆì¼€íŒ… ì±„ë„/í™ë³´ì•ˆ ì¶”ì²œ
# =============================================================================

# AIì˜ ì§€ì‹ ë² ì´ìŠ¤ - í˜ë¥´ì†Œë‚˜ ë§µ
PERSONA_MAP = {
    'M12_FME_1020_RAT': {'name': 'ë””ì§€í„¸ íë ˆì´í„°', 'desc': '10-20ëŒ€ ì—¬ì„±', 'features': 'SNS ê³µìœ ë¥¼ í†µí•œ ì •ì²´ì„± í˜•ì„±, ë””í†  ì†Œë¹„, ê°€ì„±ë¹„ì™€ ê°€ì‹¬ë¹„ì˜ ì „ëµì  í˜¼í•©'},
    'M12_MAL_1020_RAT': {'name': 'íŠ¸ë Œë“œ ê²€ì¦ê°€', 'desc': '10-20ëŒ€ ë‚¨ì„±', 'features': 'ì˜¨ë¼ì¸ íŠ¸ë Œë“œì˜ ì˜¤í”„ë¼ì¸ ê²½í—˜ ë° ê²€ì¦, ê°€ì„±ë¹„ ì¤‘ì‹œ, ë² ì´ìŠ¤ìº í”„ë¡œì„œì˜ ê³µê°„ í™œìš©'},
    'M12_FME_30_RAT': {'name': 'ì „ëµì  ìµœì í™” ì „ë¬¸ê°€', 'desc': '30ëŒ€ ì—¬ì„±', 'features': 'ì‹œê°„/ë¹„ìš©/ì—ë„ˆì§€ì˜ ìµœì í™”, ê°€ì¹˜ ê²½í—˜ ê·¹ëŒ€í™”, ë¶„ì´ˆì‚¬íšŒ'},
    'M12_MAL_30_RAT': {'name': 'íš¨ìœ¨ ì¶”êµ¬ í”„ë¡œí˜ì…”ë„', 'desc': '30ëŒ€ ë‚¨ì„±', 'features': 'ì—…ë¬´ì™€ ì¼ìƒ ì† ëª¨ë“  ì ‘ì ì—ì„œ ì‹œê°„ê³¼ ë…¸ë ¥ ì ˆì•½, ê¸°ëŠ¥ì  ì†Œë¹„'},
    'M12_FME_40_RAT': {'name': 'ê°€ì¡± ì›°ë¹™ ì„¤ê³„ì', 'desc': '40ëŒ€ ì—¬ì„±', 'features': 'ê°€ì¡±ì˜ ê±´ê°•ê³¼ ê²½í—˜ì— ëŒ€í•œ í”„ë¦¬ë¯¸ì—„ ê°€ì¹˜ íˆ¬ì, ì»¤ë®¤ë‹ˆí‹° ì •ë³´ êµë¥˜'},
    'M12_MAL_40_RAT': {'name': 'ì•ˆì • ì¶”êµ¬ ë¦¬ë”', 'desc': '40ëŒ€ ë‚¨ì„±', 'features': 'ì‹ ë¢°í•  ìˆ˜ ìˆëŠ” ë¸Œëœë“œë¥¼ í†µí•œ ìœ„í—˜ ìµœì†Œí™”, ê²€ì¦ëœ í’ˆì§ˆ ì„ í˜¸'},
    'M12_FME_50_RAT': {'name': 'ì»¤ë®¤ë‹ˆí‹° ì•µì»¤', 'desc': '50ëŒ€ ì—¬ì„±', 'features': 'ì‚¬íšŒì  ê´€ê³„ë§ì˜ ì¤‘ì‹¬ìœ¼ë¡œì„œ ì†Œí†µê³¼ êµë¥˜ ì£¼ë„, í¸ì•ˆí•¨ê³¼ ê´€ê³„ ì¤‘ì‹œ'},
    'M12_MAL_50_RAT': {'name': 'ë¡œì»¬ í—ˆë¸Œ', 'desc': '50ëŒ€ ë‚¨ì„±', 'features': 'ë‹¨ê³¨ ë¬¸í™”ë¥¼ í†µí•´ ì§€ì—­ ì»¤ë®¤ë‹ˆí‹°ì˜ êµ¬ì‹¬ì  ì—­í• , ìµìˆ™í•¨ ì„ í˜¸'},
    'M12_FME_60_RAT': {'name': 'ì›°ë‹ˆìŠ¤ ë¼ì´í”„ ì¶”êµ¬ì', 'desc': '60ëŒ€ ì´ìƒ ì—¬ì„±', 'features': 'ì‹ ì²´ì /ì •ì„œì  ì›°ë¹™ì„ ìœ„í•œ ì ê·¹ì ì¸ ì†Œë¹„ì™€ í™œë™'},
    'M12_MAL_60_RAT': {'name': 'ê²½í—˜ ê°€ì¹˜ íˆ¬ìì', 'desc': '60ëŒ€ ì´ìƒ ë‚¨ì„±', 'features': 'ì¶•ì ëœ ìì‚°ì„ í†µí•´ ê´€ê³„ì™€ ì˜ë¯¸ ìˆëŠ” ê²½í—˜ì— íˆ¬ì'}
}

@tool
def customer_based_marketing_tool(store_id: str, df_all_join: pd.DataFrame, df_prompt_dna: pd.DataFrame) -> str:
    """
    ì¹´í˜ ì—…ì¢… ê°€ë§¹ì ì˜ ì£¼ìš” ë°©ë¬¸ ê³ ê° íŠ¹ì„±ì„ ë°ì´í„° ê¸°ë°˜ìœ¼ë¡œ ë¶„ì„í•˜ê³ , 
    ê°€ì¥ íš¨ê³¼ì ì¸ ë§ˆì¼€íŒ… ì±„ë„ê³¼ êµ¬ì²´ì ì¸ í™ë³´ ë¬¸êµ¬ë¥¼ ì¶”ì²œí•˜ëŠ” ì „ë¬¸ ë„êµ¬.
    'ì¹´í˜', 'ê³ ê° ë¶„ì„', 'í™ë³´' ê´€ë ¨ ì§ˆë¬¸ì— ì‚¬ìš©ëœë‹¤.
    
    Args:
        store_id: ë¶„ì„í•  ê°€ë§¹ì  ID
        df_all_join: ì „ì²´ JOIN ë°ì´í„°
        df_prompt_dna: AIìƒë‹´ì‚¬ í•µì‹¬ì „ëµ í”„ë¡¬í”„íŠ¸ ë°ì´í„°
    
    Returns:
        ë¶„ì„ ê²°ê³¼ ë° ë§ˆì¼€íŒ… ì „ëµ ì œì•ˆ ë¦¬í¬íŠ¸
    """
    try:
        # 1. ê³µí†µ í—¬í¼ í•¨ìˆ˜ í˜¸ì¶œ (ë°˜í™˜ ë³€ìˆ˜ëª… ë³€ê²½)
        basic_info_content, latest_store_data = _get_store_basic_info(store_id, df_all_join)
        
        if latest_store_data is None:
            return basic_info_content # ì˜¤ë¥˜ ë©”ì‹œì§€ëŠ” ê·¸ëŒ€ë¡œ ë°˜í™˜

        # 2. ì¹´í˜ ì—…ì¢… í™•ì¸
        if latest_store_data['ì—…ì¢…_ì •ê·œí™”2_ëŒ€ë¶„ë¥˜'] != 'ì¹´í˜':
            return basic_info_content + f"\nğŸš¨ ë¶„ì„ ì‹¤íŒ¨: '{store_id}' ê°€ë§¹ì ì€ 'ì¹´í˜' ì—…ì¢…ì´ ì•„ë‹™ë‹ˆë‹¤."

        # 1ë‹¨ê³„: ë°ì´í„° ë¶„ì„ ì—”ì§„
        persona_columns = list(PERSONA_MAP.keys())

        store_df = df_all_join[(df_all_join['ENCODED_MCT'] == store_id) & (df_all_join['ì—…ì¢…_ì •ê·œí™”2_ëŒ€ë¶„ë¥˜'] == 'ì¹´í˜')].copy()

        analysis_df = store_df[persona_columns]
        store_persona_data = analysis_df.mean()
        
        store_persona_data = store_persona_data.dropna()
        if store_persona_data.empty:
             return f"ë¶„ì„ ì‹¤íŒ¨: '{store_id}' ê°€ë§¹ì ì˜ ìœ íš¨í•œ ê³ ê° ë¹„ì¤‘ ë°ì´í„°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."

        max_value = store_persona_data.max()
        if pd.isna(max_value):
             return f"ë¶„ì„ ì‹¤íŒ¨: '{store_id}' ê°€ë§¹ì ì˜ ìµœëŒ€ ê³ ê° ë¹„ì¤‘ ê°’ì„ ê³„ì‚°í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤."
        threshold = max_value - 5.0

        top_segments = store_persona_data[store_persona_data >= threshold]
        
        if len(top_segments) > 2:
            top_segments = top_segments.sort_values(ascending=False).head(2)
            
        if top_segments.empty:
             top_segments = store_persona_data.sort_values(ascending=False).head(2)
             if top_segments.empty:
                 return f"ë¶„ì„ ì‹¤íŒ¨: '{store_id}' ê°€ë§¹ì ì˜ ìœ íš¨í•œ ì£¼ìš” ê³ ê°ì¸µì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. (ëª¨ë“  ê³ ê° ë¹„ì¤‘ ë°ì´í„°ê°€ ìœ íš¨í•˜ì§€ ì•Šê±°ë‚˜ 0ì— ê°€ê¹Œìš¸ ìˆ˜ ìˆìŠµë‹ˆë‹¤.)"

        # ë°ì´í„° ê·¼ê±° ì¶”ì¶œ 1: í•µì‹¬ ê³ ê° ì„¸ê·¸ë¨¼íŠ¸ ì»¬ëŸ¼ëª… ë° í˜ë¥´ì†Œë‚˜ ì´ë¦„
        top_segment_cols = top_segments.index.tolist()
        main_personas_info = [PERSONA_MAP[seg] for seg in top_segment_cols]
        main_personas_str = ", ".join([f"{p['name']}({p['desc']})" for p in main_personas_info])
        # ì»¬ëŸ¼ëª…ê³¼ í˜ë¥´ì†Œë‚˜ ì´ë¦„ì„ ë§¤ì¹­í•˜ì—¬ ë¬¸ìì—´ ìƒì„±
        persona_col_mapping_str = ", ".join([f"{col} -> {PERSONA_MAP[col]['name']}" for col in top_segment_cols])
        
        main_personas_details_list = []
        for p in main_personas_info:
            detail = f"  - **{p['name']} ({p['desc']})**: {p['features']}"
            main_personas_details_list.append(detail)
        main_personas_details_str = "\n".join(main_personas_details_list) # LLM í”„ë¡¬í”„íŠ¸ìš© ìƒì„¸ ì„¤ëª…
        
        # í•µì‹¬ ì„±ê³µ ì „ëµ ë¶„ì„
        store_data = df_all_join[df_all_join['ENCODED_MCT'] == store_id]
        if store_data.empty:
            return f"ë¶„ì„ ì‹¤íŒ¨: '{store_id}' ê°€ë§¹ì ì˜ ìƒì„¸ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."
        
        latest_data = store_data.sort_values(by='TA_YM', ascending=False).iloc[0]
        store_commercial_area = latest_data['HPSN_MCT_BZN_CD_NM']
        
        if pd.isna(store_commercial_area):
            store_commercial_area = 'ë¹„ìƒê¶Œ'
        
        dna_row = df_prompt_dna[(df_prompt_dna['ìƒê¶Œ'] == store_commercial_area) & (df_prompt_dna['ì—…ì¢…'] == 'ì¹´í˜')]
        if dna_row.empty:
            return f"ë¶„ì„ ì‹¤íŒ¨: '{store_commercial_area}' ìƒê¶Œì˜ 'ì¹´í˜' ì—…ì¢… ì„±ê³µ DNAë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."
        
        # ë°ì´í„° ê·¼ê±° ì¶”ì¶œ 2: í•µì‹¬ ì„±ê³µ ë³€ìˆ˜ ì»¬ëŸ¼ëª… ë° ì „ëµ ë‚´ìš©
        key_factor_col = dna_row['í•µì‹¬ì„±ê³µë³€ìˆ˜(DNA)'].iloc[0] # ì»¬ëŸ¼ëª… ì €ì¥
        core_strategy = dna_row['í•µì‹¬ê²½ì˜ì „ëµ'].iloc[0] # ì „ëµ ë‚´ìš© ì €ì¥

        # 2ë‹¨ê³„: LLM í˜¸ì¶œì„ ìœ„í•œ í”„ë¡¬í”„íŠ¸ ìƒì„± (ì´ ë¶€ë¶„ì€ ì´ì „ê³¼ ë™ì¼)
        prompt_for_gemini = f"""
# MISSION
ë„ˆëŠ” **'ê³ ê° ì‹¬ë¦¬ ë¶„ì„ê°€'ì´ì 'ì‹¤í–‰ ì¤‘ì‹¬ ì „ëµ ì»¨ì„¤í„´íŠ¸'**ì¸ 'AI ë¹„ë°€ìƒë‹´ì‚¬'ë‹¤.
ë„ˆì˜ ì„ë¬´ëŠ” ì‚¬ì¥ë‹˜ ê°€ê²Œì˜ **í•µì‹¬ ê³ ê°(WHO) ë°ì´í„°**ì™€ **ê²€ì¦ëœ ì„±ê³µ ì „ëµ(WHAT) ë°ì´í„°**ë¥¼ ë¶„ì„í•˜ì—¬, ì‚¬ì¥ë‹˜ì´ **'ê·¸ë˜ì„œ ë‹¹ì¥ ë­˜ í•´ì•¼ í•˜ëŠ”ì§€'** ëª…í™•íˆ ì•Œ ìˆ˜ ìˆëŠ” **êµ¬ì²´ì ì¸ ë§ˆì¼€íŒ… ì•¡ì…˜ í”Œëœ**ì„ ì œì‹œí•˜ëŠ” ê²ƒì´ë‹¤.

---

# DATA INPUT (ë„ˆê°€ ë¶„ì„í•  í•µì‹¬ ë°ì´í„°)
1. **[WHO] ìš°ë¦¬ ê°€ê²Œ í•µì‹¬ ê³ ê° í˜ë¥´ì†Œë‚˜:**
{main_personas_details_str}

2. **[WHAT] ìš°ë¦¬ ê°€ê²Œì˜ ì‹œì¥ ì„±ê³µ ì „ëµ:**
- '{core_strategy}'

---

# OUTPUT INSTRUCTION (ì•„ë˜ ì§€ì‹œì‚¬í•­ê³¼ í˜•ì‹ì„ ì—„ê²©í•˜ê²Œ ë”°ë¼ì„œ ê²°ê³¼ë¬¼ì„ ìƒì„±í•´ì¤˜)

## 1. ì „ì²´ í†¤ì•¤ë§¤ë„ˆ
- **ê³ ê° ì¤‘ì‹¬ì˜ ì¡°ì–¸ê°€:** ëª¨ë“  ì„¤ëª…ê³¼ ì œì•ˆì˜ ì£¼ì–´ë¥¼ 'ê³ ê°'ìœ¼ë¡œ ì‚¼ì•„, ì‚¬ì¥ë‹˜ì´ ê³ ê°ì˜ ì…ì¥ì—ì„œ ìƒê°í•˜ë„ë¡ ìì—°ìŠ¤ëŸ½ê²Œ ìœ ë„í•´ì¤˜.
- **ë…¼ë¦¬ì  ìŠ¤í† ë¦¬í…”ëŸ¬:** 'ê³ ê°ì€ ~ì„ ì›í•˜ê¸° ë•Œë¬¸ì—(WHO ë¶„ì„) â†’ ìš°ë¦¬ ê°€ê²ŒëŠ” ~ë°©ì‹ìœ¼ë¡œ ì„±ê³µí•  ìˆ˜ ìˆëŠ”ë°(WHAT ë¶„ì„) â†’ ë”°ë¼ì„œ ì´ë ‡ê²Œ ê³µëµí•´ì•¼ í•©ë‹ˆë‹¤(í•µì‹¬ ë°©í–¥ ë° ì•¡ì…˜ í”Œëœ)' ë¼ëŠ” ëª…í™•í•œ ë…¼ë¦¬ì  íë¦„ìœ¼ë¡œ ìŠ¤í† ë¦¬ë¥¼ ì „ê°œí•´ì¤˜.

## 2. ìµœì¢… ê²°ê³¼ë¬¼ í˜•ì‹ (ì´ êµ¬ì¡°ë¥¼ ì™„ë²½í•˜ê²Œ ë”°ë¼ì¤˜)

**(ê³ ê°ì— ëŒ€í•œ ê¹Šì€ ì´í•´ë¥¼ ê°•ì¡°í•˜ë©°, ë”°ëœ»í•œ ì¸ì‚¬ë§ë¡œ ì‹œì‘)**

---

**1. ìš°ë¦¬ ê°€ê²Œì˜ í•µì‹¬ ì£¼ìš” ê³ ê°ì¸µ ì •ë³´ (WHO: ê³ ê° í˜ë¥´ì†Œë‚˜ ì‹¬ì¸µ ë¶„ì„)**
(DATAì˜ **[WHO]**ë¥¼ ë°”íƒ•ìœ¼ë¡œ, ì´ ê³ ê°ë“¤ì´ 'ì™œ' ìš°ë¦¬ ì¹´í˜ë¥¼ ì°¾ëŠ”ì§€, ê·¸ë“¤ì˜ **ì¼ìƒ, ê°€ì¹˜ê´€, ì†Œë¹„ íŒ¨í„´, ìš•ë§(Needs/Wants)** ë“±ì„ ê¹Šì´ ìˆê²Œ íŒŒê³ ë“¤ì–´ ì‚¬ì¥ë‹˜ì´ ê³ ê°ì„ **ë§ˆì¹˜ ì˜†ì—ì„œ ë³´ëŠ” ê²ƒì²˜ëŸ¼** ìƒìƒí•˜ê²Œ ì´í•´í•  ìˆ˜ ìˆë„ë¡ ìƒì„¸íˆ ë¬˜ì‚¬í•´ì¤˜. ë‹¨ìˆœíˆ íŠ¹ì§• ë‚˜ì—´ì´ ì•„ë‹ˆë¼, ìŠ¤í† ë¦¬ê°€ ëŠê»´ì§€ë„ë¡ ì„¤ëª…í•´ì•¼ í•œë‹¤.)

---

**2. ìš°ë¦¬ ê°€ê²Œì— ëŒ€ì…í•  í•µì‹¬ ì„±ê³µ ì „ëµ (WHAT: í•µì‹¬ ì„±ê³µ ì „ëµ ì‹¬ì¸µ ë¶„ì„)**
(DATAì˜ **[WHAT]** ì „ëµì„ ì„¤ëª…í•˜ë˜, ì´ ì „ëµì´ **ì™œ (1)ë²ˆ ê³ ê°ë“¤ì˜ ë§ˆìŒì„ ì–»ëŠ” ë° ê°€ì¥ íš¨ê³¼ì ì¸ 'ë¬´ê¸°'ê°€ ë  ìˆ˜ ìˆëŠ”ì§€** ê·¸ ì´ìœ ë¥¼ ëª…í™•í•˜ê³  ì„¤ë“ë ¥ ìˆê²Œ ì„¤ëª…í•´ì¤˜. ì´ ì „ëµì˜ ë³¸ì§ˆê³¼ ê¸°ëŒ€ íš¨ê³¼ë¥¼ ì‚¬ì¥ë‹˜ì´ ì •í™•íˆ ì´í•´í•˜ë„ë¡ ë•ëŠ” ê²ƒì´ ëª©í‘œë‹¤.)

---

**3. ìµœì í™”ëœ ê²°ë¡  ë„ì¶œ (WHO + WHAT ì—°ê²° ë° í•µì‹¬ ë§ˆì¼€íŒ… ë°©í–¥)**
(ì´ì œ (1)ë²ˆì˜ ê³ ê° ë¶„ì„ê³¼ (2)ë²ˆì˜ ì „ëµ ë¶„ì„ì„ **ë…¼ë¦¬ì ìœ¼ë¡œ ì—°ê²°**í•´ì•¼ í•œë‹¤. **"(1)ë²ˆ ê³ ê°ì˜ ì–´ë–¤ êµ¬ì²´ì ì¸ ì‹¬ë¦¬/ìš•êµ¬** ë•Œë¬¸ì—, **(2)ë²ˆ ì „ëµì„ í™œìš©í•˜ëŠ” ê²ƒì´ ì™œ ìš°ë¦¬ ê°€ê²Œì—ê²Œ ìµœì ì˜ ì„ íƒì¸ì§€"** ëª…í™•í•˜ê²Œ ì„¤ëª…í•´ì¤˜. ì´ ì—°ê²°ê³ ë¦¬ë¥¼ ë°”íƒ•ìœ¼ë¡œ, ìš°ë¦¬ ê°€ê²Œê°€ ì•ìœ¼ë¡œ ë‚˜ì•„ê°€ì•¼ í•  **ê°€ì¥ ì¤‘ìš”í•œ ë§ˆì¼€íŒ… ë°©í–¥**ì„ í•œ ë¬¸ì¥ìœ¼ë¡œ ëª…í™•í•˜ê²Œ ì •ì˜í•œë‹¤.)
    * ì˜ˆì‹œ) "SNS ê³µìœ ë¥¼ ì¦ê¸°ê³  íŠ¹ë³„í•œ ê²½í—˜ì„ ì¤‘ì‹œí•˜ëŠ” 1020 ì—¬ì„± ê³ ê°ì˜ íŠ¹ì„±ì„ ê³ ë ¤í•  ë•Œ, 'ê¸°ì¡´ ê³ ê° ì¶©ì„±ë„ ê°•í™” ë° ê´€ê³„ ì‹¬í™”' ì „ëµì€ ì´ë“¤ì—ê²Œ 'ë‚˜ë§Œ ì•„ëŠ” íŠ¹ë³„í•œ ê³µê°„'ì´ë¼ëŠ” ì¸ì‹ì„ ì‹¬ì–´ì£¼ê³  ìë°œì ì¸ ë°”ì´ëŸ´ì„ ìœ ë„í•˜ëŠ” ìµœì ì˜ ê²½ë¡œì…ë‹ˆë‹¤. ë”°ë¼ì„œ ìš°ë¦¬ ê°€ê²Œì˜ í•µì‹¬ ë§ˆì¼€íŒ… ë°©í–¥ì€ **'ì¸ìŠ¤íƒ€ê·¸ë¨ ì¤‘ì‹¬ì˜ ì°¸ì—¬í˜• ì½˜í…ì¸ ë¥¼ í†µí•´ ë‹¨ê³¨ ê³ ê°ê³¼ì˜ ìœ ëŒ€ê°ì„ ê°•í™”í•˜ëŠ” ê²ƒ'** ì…ë‹ˆë‹¤."

---

**4. ì‚¬ì¥ë‹˜ ë§ì¶¤í˜• ì‹¤ì „ ë§ˆì¼€íŒ… ì•¡ì…˜ í”Œëœ**
(ì´ì œ ì•ì„œ ì •ì˜í•œ **(3)ë²ˆ í•µì‹¬ ë§ˆì¼€íŒ… ë°©í–¥**ì— ë”°ë¼, ì‚¬ì¥ë‹˜ì´ ë°”ë¡œ ì‹¤í–‰í•  ìˆ˜ ìˆëŠ” êµ¬ì²´ì ì¸ ì•¡ì…˜ í”Œëœì„ ì œì‹œí•œë‹¤.)

**ğŸ“ˆ ìµœì  ë§ˆì¼€íŒ… ì±„ë„ ì¶”ì²œ**
(íƒ€ê²Ÿ ê³ ê° **[WHO]**ê°€ ê°€ì¥ í™œë°œí•˜ê²Œ ì´ìš©í•˜ê³ , **[WHAT]** ì „ëµì„ í¼ì¹˜ê¸° ì¢‹ì€ ì±„ë„ 1~2ê°œë¥¼ ì„ ì •í•œë‹¤.)

* **[ì±„ë„ ì´ë¦„]:**
    * **ì„ ì • ì´ìœ  (Why):**
        1. **(ê³ ê° ì ‘ì ):** ì™œ ì´ ì±„ë„ì´ **(1)ë²ˆ ê³ ê°**ì˜ ì •ë³´ ì†Œë¹„ íŒ¨í„´ ë° ë¼ì´í”„ìŠ¤íƒ€ì¼ì— ê°€ì¥ ì í•©í•œê°€? (**[WHO] ë°ì´í„°** ì–¸ê¸‰ í•„ìˆ˜)
        2. **(ì „ëµ ì‹¤í–‰):** ì–´ë–»ê²Œ ì´ ì±„ë„ì—ì„œ **(2)ë²ˆ ì „ëµ**ì„ ê°€ì¥ íš¨ê³¼ì ìœ¼ë¡œ êµ¬í˜„í•˜ì—¬ ê³ ê°ì˜ ë§ˆìŒì„ ì‚¬ë¡œì¡ì„ ìˆ˜ ìˆëŠ”ê°€? (**[WHAT] ë°ì´í„°** ì–¸ê¸‰ í•„ìˆ˜)

**ğŸ’¡ ì¦‰ì‹œ ì‹¤í–‰ ê°€ëŠ¥í•œ í™ë³´ ë°©ì•ˆ (1~2ê°€ì§€)**
(ì‚¬ì¥ë‹˜ì´ **'ë‚´ì¼ë¶€í„° ë‹¹ì¥'** ì‹¤í–‰í•  ìˆ˜ ìˆëŠ” **êµ¬ì²´ì ì´ê³  ì°½ì˜ì ì¸ ì•„ì´ë””ì–´**ë¥¼ ì œì•ˆí•œë‹¤. ëª¨ë“  ì•„ì´ë””ì–´ëŠ” (3)ë²ˆ í•µì‹¬ ë°©í–¥ê³¼ ì¼ì¹˜í•´ì•¼ í•œë‹¤.)

**[ì•„ì´ë””ì–´ ëª…ì¹­]:** (ì˜ˆ: '#ì¹´í˜ë¡œê·¸ ì±Œë¦°ì§€' ì¸ìŠ¤íƒ€ê·¸ë¨ ì´ë²¤íŠ¸)
* **ë¬´ì—‡ì„ (What):** (ì´ ì•„ì´ë””ì–´ë¥¼ í†µí•´ **(1)ë²ˆ ê³ ê°**ì—ê²Œ ì–´ë–¤ **'êµ¬ì²´ì ì¸ ê°€ì¹˜ë‚˜ ì¦ê±°ì›€'**ì„ ì œê³µí•  ê²ƒì¸ê°€?)
* **ì–´ë–»ê²Œ (How):** (ì‚¬ì¥ë‹˜ì´ **'ë°”ë¡œ ë”°ë¼ í•  ìˆ˜ ìˆë„ë¡'** ì‹¤í–‰ ë°©ë²•, ì˜ˆìƒ ë¹„ìš©, ì¤€ë¹„ë¬¼, ê¸°ê°„ ë“±ì„ **ë‹¨ê³„ë³„ë¡œ ë§¤ìš° ìƒì„¸í•˜ê²Œ** ì„¤ëª…í•œë‹¤.)
    * ì˜ˆì‹œ) 1ë‹¨ê³„: í¬í† ì¡´ ë§Œë“¤ê¸° (ë¹„ìš©: 5ë§Œì› ì´í•˜, ì†Œí’ˆ: ì „ì‹  ê±°ìš¸, ê°ì„± ì¡°ëª…, ì‘ì€ ì‹ë¬¼), 2ë‹¨ê³„: ì¸ìŠ¤íƒ€ê·¸ë¨ ê³µì‹ ê³„ì •ì— ì´ë²¤íŠ¸ ê³µì§€ (ê¸°ê°„: 4ì£¼, í•„ìˆ˜ í•´ì‹œíƒœê·¸: #ê°€ê²Œì´ë¦„ #ì±Œë¦°ì§€ëª… #ë‹¨ê³¨ì¸ì¦), 3ë‹¨ê³„: ë§¤ì£¼ ê¸ˆìš”ì¼ ìš°ìˆ˜ì‘ 1ëª… ì„ ì • ë° DM ë°œí‘œ (ìƒí’ˆ: ì‹œê·¸ë‹ˆì²˜ ë””ì €íŠ¸ + ìŒë£Œ 1ì” ë¬´ë£Œ ì¿ í°), 4ë‹¨ê³„: ì„ ì •ì‘ ë¦¬ê·¸ë¨ ë° ì°¸ì—¬ì ê°ì‚¬ ë©”ì‹œì§€ ì „ë‹¬
* **ê¸°ëŒ€ íš¨ê³¼ (Why this works):**
    1. **(ê³ ê° ë°˜ì‘):** ì´ ì•„ì´ë””ì–´ê°€ ì™œ **(1)ë²ˆ ê³ ê°**ì˜ **[WHO] ë°ì´í„°**ì— ë‚˜íƒ€ë‚œ ì‹¬ë¦¬/ìš•êµ¬(ì˜ˆ: SNS ê³µìœ  í†µí•œ ì •ì²´ì„± í˜•ì„±, ê°€ì‹¬ë¹„ ì¶”êµ¬)ë¥¼ ì •í™•íˆ ì¶©ì¡±ì‹œì¼œ **'ì°¸ì—¬í•˜ê³  ì‹¶ë‹¤', 'ìë‘í•˜ê³  ì‹¶ë‹¤'**ëŠ” ë§ˆìŒì„ ìœ ë°œí•˜ëŠ”ê°€?
    2. **(ì „ëµ ë‹¬ì„±):** ì´ ì•„ì´ë””ì–´ê°€ ì–´ë–»ê²Œ **(2)ë²ˆ ì „ëµ ([WHAT] ë°ì´í„°)** (ì˜ˆ: ê¸°ì¡´ ê³ ê° ì¶©ì„±ë„ ê°•í™” ë° ê´€ê³„ ì‹¬í™”) ë‹¬ì„±ì— **ì§ì ‘ì ìœ¼ë¡œ ê¸°ì—¬**í•˜ë©°, ìµœì¢…ì ìœ¼ë¡œ ì¬ë°©ë¬¸ìœ¨ê³¼ ë§¤ì¶œ ì¦ëŒ€ì— ì–´ë–¤ ê¸ì •ì  ì˜í–¥ì„ ë¯¸ì¹  ê²ƒìœ¼ë¡œ ì˜ˆìƒë˜ëŠ”ê°€?

---

**(ì‚¬ì¥ë‹˜ê»˜ ë°ì´í„° ê¸°ë°˜ ë§ˆì¼€íŒ…ì˜ ì¤‘ìš”ì„±ì„ ê°•ì¡°í•˜ë©°, ì‹¤í–‰ì„ ë…ë ¤í•˜ëŠ” ì§„ì‹¬ ì–´ë¦° ë©”ì‹œì§€ë¡œ ë§ˆë¬´ë¦¬)**
"""
        
        # [*** ì—¬ê¸°ê°€ ìˆ˜ì •ëœ ë¶€ë¶„ ***]
        # LLM ì§ì ‘ í˜¸ì¶œ ì¶”ê°€ ë° final_report êµ¬ì¡° ë³€ê²½

        # LLM í˜¸ì¶œ
        llm_response = call_gemini_llm(prompt_for_gemini)

        # ë°ì´í„° ê·¼ê±° ìš”ì•½ ì„¹ì…˜ ìƒì„±
        data_summary_section = f"""
---
## ğŸ“Š AI ë¶„ì„ í•µì‹¬ ë°ì´í„° ê·¼ê±°

* **í•µì‹¬ ê³ ê°ì¸µ (ê³ ê° ë°ì´í„° -> í˜ë¥´ì†Œë‚˜):** {persona_col_mapping_str}
* **í•µì‹¬ ì„±ê³µ ë³€ìˆ˜ (ë°ì´í„°):** {key_factor_col}
* **ì ìš©ë  í•µì‹¬ ì„±ê³µ ì „ëµ:** '{core_strategy}' (ìƒê¶Œ: {store_commercial_area})

---
"""

        # ìµœì¢… í†µí•© ë¦¬í¬íŠ¸ ìƒì„± (LLM ì‘ë‹µì„ í¬í•¨í•˜ë„ë¡ ìˆ˜ì •)
        final_report = f"""
======================================================================
      ğŸ¤– AI ë¹„ë°€ìƒë‹´ì‚¬ - '{store_id}' ê°€ë§¹ì  ë§ì¶¤ ì „ëµ ë¦¬í¬íŠ¸
======================================================================

{basic_info_content}

{data_summary_section} 

## ğŸ’¡ AI ì»¨ì„¤í„´íŠ¸ ìƒì„¸ ë¶„ì„ ë° ì „ëµ ì œì•ˆ
{llm_response}
"""
        # 2. í†µí•©ëœ ë¦¬í¬íŠ¸ í•˜ë‚˜ë§Œ ë°˜í™˜
        return final_report

    except Exception as e:
        import traceback
        error_details = traceback.format_exc()
        return f"""ğŸš¨ ì¹´í˜ ë§ˆì¼€íŒ… ë¶„ì„ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.

**ì˜¤ë¥˜ ìƒì„¸ ì •ë³´:**
- ì˜¤ë¥˜ ìœ í˜•: {type(e).__name__}
- ì˜¤ë¥˜ ë©”ì‹œì§€: {str(e)}
- ê°€ë§¹ì  ID: {store_id}

**í•´ê²° ë°©ë²•:**
1. ê°€ë§¹ì  IDê°€ ì˜¬ë°”ë¥¸ì§€ í™•ì¸í•´ì£¼ì„¸ìš”
2. ë°ì´í„°ë² ì´ìŠ¤ì— í•´ë‹¹ ê°€ë§¹ì  ì •ë³´ê°€ ìˆëŠ”ì§€ í™•ì¸í•´ì£¼ì„¸ìš”
3. ë¬¸ì œê°€ ì§€ì†ë˜ë©´ ê´€ë¦¬ìì—ê²Œ ë¬¸ì˜í•´ì£¼ì„¸ìš”

**ê¸°ìˆ ì  ì„¸ë¶€ì‚¬í•­:**
{error_details}"""
# =============================================================================
# ëª¨ë¸ 2: ì¬ë°©ë¬¸ìœ¨ 30% ì´í•˜ ê°€ë§¹ì  ì›ì¸ ì§„ë‹¨ ë° A/B ì „ëµ ì œì•ˆ
# =============================================================================

@tool
def revisit_rate_analysis_tool(store_id: str, df_all_join: pd.DataFrame, df_prompt_dna: pd.DataFrame) -> str:
    """
    ì¬ë°©ë¬¸ìœ¨ì´ 30% ì´í•˜ë¡œ ë‚®ì€ ê°€ë§¹ì ì˜ ê·¼ë³¸ì ì¸ ì›ì¸ì„ 3ê°€ì§€ í•µì‹¬ ë™ì¸(ê°€ê²©, ê³ ê°ì¸µ, ì±„ë„)ìœ¼ë¡œ 
    ê²½ìŸ ê·¸ë£¹ê³¼ ë¹„êµ ë¶„ì„í•˜ê³ , ì¬ë°©ë¬¸ìœ¨ì„ ë†’ì´ê¸° ìœ„í•œ A/B ì „ëµì„ ì œì•ˆí•˜ëŠ” ë„êµ¬.
    'ì¬ë°©ë¬¸', 'ë‹¨ê³¨' ë¬¸ì œì— íŠ¹í™”ë˜ì–´ ìˆë‹¤.
    
    Args:
        store_id: ë¶„ì„í•  ê°€ë§¹ì  ID
        df_all_join: ì „ì²´ JOIN ë°ì´í„°
        df_prompt_dna: AIìƒë‹´ì‚¬ í•µì‹¬ì „ëµ í”„ë¡¬í”„íŠ¸ ë°ì´í„°
    
    Returns:
        ì¬ë°©ë¬¸ìœ¨ ë¶„ì„ ë° ê°œì„  ì „ëµ ë¦¬í¬íŠ¸
    """
    try:
        # 1. ê³µí†µ í—¬í¼ í•¨ìˆ˜ í˜¸ì¶œ (ë°˜í™˜ ë³€ìˆ˜ëª… ë³€ê²½)
        basic_info_content, latest_store_data = _get_store_basic_info(store_id, df_all_join)
        
        if latest_store_data is None:
            return basic_info_content # ì˜¤ë¥˜ ë©”ì‹œì§€ëŠ” ê·¸ëŒ€ë¡œ ë°˜í™˜

        # ì ìˆ˜ ì»¬ëŸ¼ ìƒì„± (í•„ìš”í•œ ê²½ìš°)
        score_cols = ['MCT_OPE_MS_CN', 'RC_M1_TO_UE_CT', 'RC_M1_SAA', 'RC_M1_AV_NP_AT']
        for col in score_cols:
            if col in df_all_join.columns and f'{col}_SCORE' not in df_all_join.columns:
                df_all_join[f'{col}_SCORE'] = df_all_join[col].apply(get_score_from_raw)
        
        target_store_all_months = df_all_join[df_all_join['ENCODED_MCT'] == store_id]
        target_store = latest_store_data

        # ì¬ë°©ë¬¸ìœ¨ ê³„ì‚° (ì›”ë³„ í‰ê· )
        target_revisit_rate_series = target_store_all_months['MCT_UE_CLN_REU_RAT'].dropna()
        target_revisit_rate = 0.0 if target_revisit_rate_series.empty else target_revisit_rate_series.mean()

        if target_revisit_rate >= 30:
            latest_month = target_store.get('TA_YM', 'ìµœì‹ ')
            return f"ğŸ“£ ë¶„ì„ ê²°ê³¼: ì›” í‰ê·  ì¬ë°©ë¬¸ìœ¨ì´ {target_revisit_rate:.1f}%ë¡œ ì–‘í˜¸í•©ë‹ˆë‹¤. (ìµœì‹ ì›”: {latest_month})"

        industry, commercial_area = target_store['ì—…ì¢…_ì •ê·œí™”2_ëŒ€ë¶„ë¥˜'], target_store['HPSN_MCT_BZN_CD_NM']
        area_name = commercial_area if pd.notna(commercial_area) else "ë¹„ìƒê¶Œ"
        
        # ê²½ìŸ ê·¸ë£¹ ì„¤ì •
        peer_group_filter = (df_all_join['ì—…ì¢…_ì •ê·œí™”2_ëŒ€ë¶„ë¥˜'] == industry) & (df_all_join['ENCODED_MCT'] != store_id)
        if pd.isna(commercial_area):
            peer_group = df_all_join[peer_group_filter & (df_all_join['HPSN_MCT_BZN_CD_NM'].isna())]
        else:
            peer_group = df_all_join[peer_group_filter & (df_all_join['HPSN_MCT_BZN_CD_NM'] == commercial_area)]

        if len(peer_group) < 3:
            return f"ğŸ“£ ë¶„ì„ ë³´ë¥˜: ë¹„êµ ë¶„ì„ì„ ìœ„í•œ ê²½ìŸ ê·¸ë£¹ì´ ë¶€ì¡±í•©ë‹ˆë‹¤."
            
        revisit_threshold = peer_group['MCT_UE_CLN_REU_RAT'].quantile(0.5)
        successful_peers = peer_group[peer_group['MCT_UE_CLN_REU_RAT'] >= revisit_threshold]
        if successful_peers.empty:
            return f"ğŸ“£ ë¶„ì„ ë³´ë¥˜: ì„±ê³µ ê·¸ë£¹ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."

        # í‘œì¤€í™”ëœ í‰ê·  ê³„ì‚° í•¨ìˆ˜
        def get_series_mean(series):
            series_cleaned = series.dropna()
            return 0.0 if series_cleaned.empty else series_cleaned.mean()

        def get_group_mean(df, group_col, value_col):
            if df.empty or value_col not in df.columns:
                return 0.0
            group_means = df.groupby(group_col)[value_col].mean()
            final_mean = group_means.mean()
            return 0.0 if pd.isna(final_mean) else final_mean

        # ë‚´ ê°€ê²Œì˜ ì „ì²´ ê¸°ê°„ í‰ê·  ê³„ì‚°
        target_price_score_avg = get_series_mean(target_store_all_months['RC_M1_AV_NP_AT_SCORE'])
        target_resident_ratio_avg = get_series_mean(target_store_all_months['RC_M1_SHC_RSD_UE_CLN_RAT'])
        target_delivery_ratio_avg = get_series_mean(target_store_all_months['DLV_SAA_RAT'])

        # ì„±ê³µ ê·¸ë£¹ì˜ ê°€ê²Œë³„ í‰ê·  ê³„ì‚° í›„ -> ì „ì²´ í‰ê· 
        peer_price_score_avg = get_group_mean(successful_peers, 'ENCODED_MCT', 'RC_M1_AV_NP_AT_SCORE')
        peer_resident_ratio_avg = get_group_mean(successful_peers, 'ENCODED_MCT', 'RC_M1_SHC_RSD_UE_CLN_RAT')
        peer_delivery_avg = get_group_mean(successful_peers, 'ENCODED_MCT', 'DLV_SAA_RAT')
        
        # ë°°ë‹¬ ë¯¸ìš´ì˜ ê°€ê²Œ ì²˜ë¦¬ ë¡œì§
        is_delivery_not_operated = (target_delivery_ratio_avg == 0.0)
        
        delivery_target_for_analysis = target_delivery_ratio_avg
        delivery_peer_for_analysis = peer_delivery_avg

        if is_delivery_not_operated:
            delivery_peer_for_analysis = 0.0
            delivery_target_for_analysis = 0.0

        analysis_results = {
            'price_competitiveness': {'target': target_price_score_avg, 'peer_avg': peer_price_score_avg},
            'audience_alignment': {'target': target_resident_ratio_avg, 'peer_avg': peer_resident_ratio_avg},
            'channel_expansion': {'target': delivery_target_for_analysis, 'peer_avg': delivery_peer_for_analysis}
        }
        
        for key in analysis_results:
            analysis_results[key]['gap'] = analysis_results[key].get('target', np.nan) - analysis_results[key].get('peer_avg', np.nan)
        
        # í˜ë¥´ì†Œë‚˜ ì§„ë‹¨ (ì‚¬ì „ì§ˆë¬¸ 2ë²ˆ ì „ìš©)
        gaps = {k: v['gap'] for k, v in analysis_results.items() if 'gap' in v and pd.notna(v['gap'])}
        if not gaps:
            persona = "ë¶„ì„ ë¶ˆê°€"
        else:
            op_tenure_score = target_store.get('MCT_OPE_MS_CN_SCORE', 6)
            new_ratio = target_store.get('MCT_UE_CLN_NEW_RAT', 0)
            
            if op_tenure_score <= 2 and new_ratio > 60:
                persona = "ì²«ì¸ìƒë§Œ ì¢‹ì€ ì‹ ê·œ ë§¤ì¥"
            elif gaps.get('price_competitiveness', 0) < -1:
                persona = "ì¬ë°©ë¬¸í•˜ê¸°ì—” ë¶€ë‹´ìŠ¤ëŸ¬ìš´ ê°€ê²©"
            elif gaps.get('audience_alignment', 0) < -15:
                persona = "ë™ë„¤ ì£¼ë¯¼ì„ ì‚¬ë¡œì¡ì§€ ëª»í•˜ëŠ” ë§¤ì¥"
            elif gaps.get('channel_expansion', 0) < -20:
                persona = "ë°°ë‹¬ ì±„ë„ ë¶€ì¬"
            else:
                persona = "ì´ì²´ì  ë§ˆì¼€íŒ… ë¶€ì¬"

        # ì „ëµ ë°ì´í„° ì¡°íšŒ
        strategy_row = df_prompt_dna[(df_prompt_dna['ì—…ì¢…'] == industry) & (df_prompt_dna['ìƒê¶Œ'] == area_name)]
        if not strategy_row.empty:
            key_factor = strategy_row.iloc[0]['í•µì‹¬ì„±ê³µë³€ìˆ˜(DNA)']
            key_strategy = strategy_row.iloc[0]['í•µì‹¬ê²½ì˜ì „ëµ']
        else:
            key_factor = "ë°ì´í„° ì—†ìŒ"
            key_strategy = "ì¼ë°˜ì ì¸ ê°œì„  ì „ëµ í•„ìš”"

        # STAGE 3: í˜ë¥´ì†Œë‚˜ì™€ í•µì‹¬ì„±ê³µì „ëµ ìƒì„¸ ë¶„ì„
        def get_stage3_analysis(persona, key_factor, key_strategy, analysis_results):
            # í˜ë¥´ì†Œë‚˜ ìƒì„¸ ì„¤ëª…
            persona_explanation = ""
            if persona == "ì²«ì¸ìƒë§Œ ì¢‹ì€ ì‹ ê·œ ë§¤ì¥":
                persona_explanation = f"""
**ğŸ“Š í˜ë¥´ì†Œë‚˜ ì§„ë‹¨: '{persona}'**

[ë°ì´í„° ê·¼ê±°]
- ìš´ì˜ ê¸°ê°„: {translate_metric('tenure', target_store.get('MCT_OPE_MS_CN'))} (ì‹ ê·œ ë§¤ì¥)
- ì‹ ê·œ ê³ ê° ë¹„ìœ¨: {target_store.get('MCT_UE_CLN_NEW_RAT', 0):.1f}% (60% ì´ˆê³¼)
- í˜„ì¬ ì¬ë°©ë¬¸ìœ¨: {target_revisit_rate:.2f}% (30% ë¯¸ë§Œ)

[í˜ë¥´ì†Œë‚˜ íŠ¹ì„± ë¶„ì„]
ì´ ìœ í˜•ì€ 'ì²« ë°©ë¬¸ì€ ë§ì§€ë§Œ ì¬ë°©ë¬¸ì´ ì ì€' ì „í˜•ì ì¸ ì‹ ê·œ ë§¤ì¥ íŒ¨í„´ì…ë‹ˆë‹¤. 
ê³ ê°ë“¤ì´ ì²« ë°©ë¬¸ì—ì„œëŠ” ë§Œì¡±í•˜ì§€ë§Œ, ì¬ë°©ë¬¸í•  ë§Œí•œ ì¶©ë¶„í•œ ë™ê¸°ë‚˜ ëª…ë¶„ì„ ì œê³µí•˜ì§€ ëª»í•˜ê³  ìˆìŠµë‹ˆë‹¤.
ì‹ ê·œ ê³ ê°ì´ ì¶©ì„± ê³ ê°ìœ¼ë¡œ ì „í™˜ë˜ëŠ” 'ì˜¨ë³´ë”©(Onboarding)' ê³¼ì •ì—ì„œ ì‹¤íŒ¨í•˜ê³  ìˆëŠ” ìƒí™©ì…ë‹ˆë‹¤."""
            elif persona == "ì¬ë°©ë¬¸í•˜ê¸°ì—” ë¶€ë‹´ìŠ¤ëŸ¬ìš´ ê°€ê²©":
                persona_explanation = f"""
**ğŸ“Š í˜ë¥´ì†Œë‚˜ ì§„ë‹¨: '{persona}'**

[ë°ì´í„° ê·¼ê±°]
- ê°ë‹¨ê°€ ìˆ˜ì¤€: {translate_metric('level', target_store.get('RC_M1_AV_NP_AT'))} (ìµœì‹ ì›” ê¸°ì¤€)
- ì„±ê³µ ê·¸ë£¹ ëŒ€ë¹„ ê²©ì°¨: {analysis_results['price_competitiveness']['gap']:.2f}ì  (ê°ë‹¨ê°€ ì ìˆ˜ê°€ ë‚®ìŒ)
- í˜„ì¬ ì¬ë°©ë¬¸ìœ¨: {target_revisit_rate:.2f}% (30% ë¯¸ë§Œ)

[í˜ë¥´ì†Œë‚˜ íŠ¹ì„± ë¶„ì„]
ì´ ìœ í˜•ì€ ê°€ê²© ê²½ìŸë ¥ì—ì„œ ì„±ê³µ ê·¸ë£¹ ëŒ€ë¹„ ëª…í™•í•œ ê²©ì°¨ë¥¼ ë³´ì´ëŠ” ë§¤ì¥ì…ë‹ˆë‹¤.
ê³ ê°ë“¤ì´ ì²« ë°©ë¬¸ í›„ 'ê°€ê²©ì´ ë¶€ë‹´ìŠ¤ëŸ½ë‹¤'ëŠ” ì¸ì‹ì„ ê°€ì§€ê³  ì¬ë°©ë¬¸ì„ êº¼ë¦¬ëŠ” ìƒí™©ì…ë‹ˆë‹¤.
ë‹¨ìˆœíˆ ê°€ê²©ì„ ë‚®ì¶”ëŠ” ê²ƒì´ ì•„ë‹ˆë¼, ê°€ê²© ëŒ€ë¹„ ê°€ì¹˜ë¥¼ ë†’ì´ëŠ” ì „ëµì´ í•„ìš”í•©ë‹ˆë‹¤."""
            elif persona == "ë™ë„¤ ì£¼ë¯¼ì„ ì‚¬ë¡œì¡ì§€ ëª»í•˜ëŠ” ë§¤ì¥":
                persona_explanation = f"""
**ğŸ“Š í˜ë¥´ì†Œë‚˜ ì§„ë‹¨: '{persona}'**

[ë°ì´í„° ê·¼ê±°]
- ê±°ì£¼ ê³ ê° ë¹„ìœ¨: {analysis_results['audience_alignment'].get('target', 0):.1f}% (ì›” í‰ê· )
- ì„±ê³µ ê·¸ë£¹ ëŒ€ë¹„ ê²©ì°¨: {analysis_results['audience_alignment']['gap']:.1f}%p (ê±°ì£¼ ê³ ê° ë¶€ì¡±)
- í˜„ì¬ ì¬ë°©ë¬¸ìœ¨: {target_revisit_rate:.2f}% (30% ë¯¸ë§Œ)

[í˜ë¥´ì†Œë‚˜ íŠ¹ì„± ë¶„ì„]
ì´ ìœ í˜•ì€ ë™ë„¤ ì£¼ë¯¼ ê³ ê° í™•ë³´ì— ì‹¤íŒ¨í•œ ë§¤ì¥ì…ë‹ˆë‹¤.
ì„±ê³µ ê·¸ë£¹ ëŒ€ë¹„ ê±°ì£¼ ê³ ê° ë¹„ìœ¨ì´ í˜„ì €íˆ ë‚®ì•„, ë‹¨ê³¨ ê³ ê° ê¸°ë°˜ì´ ì•½í•œ ìƒí™©ì…ë‹ˆë‹¤.
ì§€ì—­ ì»¤ë®¤ë‹ˆí‹°ì™€ì˜ ê´€ê³„ êµ¬ì¶•ì´ ì‹œê¸‰í•œ ê³¼ì œì…ë‹ˆë‹¤."""
            elif persona == "ë°°ë‹¬ ì±„ë„ ë¶€ì¬":
                persona_explanation = f"""
**ğŸ“Š í˜ë¥´ì†Œë‚˜ ì§„ë‹¨: '{persona}'**

[ë°ì´í„° ê·¼ê±°]
- ë°°ë‹¬ ë§¤ì¶œ ë¹„ì¤‘: {target_delivery_ratio_avg:.1f}% (ì›” í‰ê· , ë°°ë‹¬ ë¯¸ìš´ì˜)
- ì„±ê³µ ê·¸ë£¹ ëŒ€ë¹„ ê²©ì°¨: {analysis_results['channel_expansion']['gap']:.1f}%p (ë°°ë‹¬ ì±„ë„ ë¶€ì¬)
- í˜„ì¬ ì¬ë°©ë¬¸ìœ¨: {target_revisit_rate:.2f}% (30% ë¯¸ë§Œ)

[í˜ë¥´ì†Œë‚˜ íŠ¹ì„± ë¶„ì„]
ì´ ìœ í˜•ì€ ë°°ë‹¬ ì±„ë„ì„ ì „í˜€ í™œìš©í•˜ì§€ ì•ŠëŠ” ë§¤ì¥ì…ë‹ˆë‹¤.
í˜„ëŒ€ ê³ ê°ì˜ ë‹¤ì–‘í•œ ì†Œë¹„ íŒ¨í„´(ë§¤ì¥ ë°©ë¬¸ + ë°°ë‹¬ ì£¼ë¬¸)ì„ ì¶©ì¡±ì‹œí‚¤ì§€ ëª»í•˜ê³  ìˆìŠµë‹ˆë‹¤.
ì˜¨ë¼ì¸ ê³ ê° ì ‘ì  í™•ë³´ê°€ ì‹œê¸‰í•œ ê³¼ì œì…ë‹ˆë‹¤."""
            else:  # "ì´ì²´ì  ë§ˆì¼€íŒ… ë¶€ì¬"
                persona_explanation = f"""
**ğŸ“Š í˜ë¥´ì†Œë‚˜ ì§„ë‹¨: '{persona}'**

[ë°ì´í„° ê·¼ê±°]
- ê°€ê²© ê²½ìŸë ¥ ê²©ì°¨: {analysis_results['price_competitiveness']['gap']:.2f}ì 
- ê±°ì£¼ ê³ ê° ê²©ì°¨: {analysis_results['audience_alignment']['gap']:.1f}%p  
- ë°°ë‹¬ ì±„ë„ ê²©ì°¨: {analysis_results['channel_expansion']['gap']:.1f}%p
- í˜„ì¬ ì¬ë°©ë¬¸ìœ¨: {target_revisit_rate:.2f}% (30% ë¯¸ë§Œ)

[í˜ë¥´ì†Œë‚˜ íŠ¹ì„± ë¶„ì„]
ì´ ìœ í˜•ì€ 3ê°€ì§€ í•µì‹¬ ë™ì¸ ëª¨ë‘ì—ì„œ ì„±ê³µ ê·¸ë£¹ ëŒ€ë¹„ ë¶€ì¡±í•œ ë§¤ì¥ì…ë‹ˆë‹¤.
ê°œë³„ ì§€í‘œì˜ ë¬¸ì œë¼ê¸°ë³´ë‹¤ëŠ” ì „ì²´ì ì¸ ë§ˆì¼€íŒ… ì „ëµê³¼ ê³ ê° ê´€ë¦¬ ì‹œìŠ¤í…œì´ ë¶€ì¬í•œ ìƒí™©ì…ë‹ˆë‹¤.
ì²´ê³„ì ì¸ ë§ˆì¼€íŒ… ì¸í”„ë¼ êµ¬ì¶•ì´ ì‹œê¸‰í•œ ê³¼ì œì…ë‹ˆë‹¤."""

            # í•µì‹¬ì„±ê³µì „ëµ ìƒì„¸ ì„¤ëª…
            strategy_explanation = f"""
**ğŸ¯ í•µì‹¬ ì„±ê³µ ì „ëµ: '{key_factor}'**

[ë°ì´í„° ê·¼ê±°]
- ì—…ì¢…/ìƒê¶Œ: {industry} / {area_name}
- ì„±ê³µ ê·¸ë£¹ ë¶„ì„ ê²°ê³¼ ë„ì¶œëœ í•µì‹¬ ì„±ê³µ ë³€ìˆ˜

[ì „ëµ ìƒì„¸ ë¶„ì„]
'{key_strategy}'

ì´ ì „ëµì€ ë™ì¼ ì—…ì¢…, ë™ì¼ ìƒê¶Œ ë‚´ì—ì„œ ì¬ë°©ë¬¸ìœ¨ì´ ë†’ì€ ì„±ê³µ ê·¸ë£¹ì˜ ê³µí†µëœ íŠ¹ì§•ì„ ë¶„ì„í•œ ê²°ê³¼ì…ë‹ˆë‹¤.
ë°ì´í„° ê¸°ë°˜ìœ¼ë¡œ ê²€ì¦ëœ ì„±ê³µ ë°©ì •ì‹ì´ë¯€ë¡œ, ì´ë¥¼ ê¸°ë°˜ìœ¼ë¡œ í•œ ë§ˆì¼€íŒ… ì „ëµ ìˆ˜ë¦½ì´ íš¨ê³¼ì ì…ë‹ˆë‹¤."""

            return persona_explanation + strategy_explanation

        # STAGE 4: í˜ë¥´ì†Œë‚˜ + í•µì‹¬ì„±ê³µì „ëµ ìœµí•© ë§ˆì¼€íŒ… ì „ëµ
        # [*** ì—¬ê¸°ê°€ ìˆ˜ì •ëœ ë¶€ë¶„ ***]
        def get_stage4_integrated_strategy(persona, key_factor, key_strategy, analysis_results):
            # í˜ë¥´ì†Œë‚˜ë³„ ê¸°ë³¸ ì „ëµ í…œí”Œë¦¿ (ì´ ë‚´ìš©ì€ ê·¸ëŒ€ë¡œ ì‚¬ìš©)
            persona_strategies = {
                "ì²«ì¸ìƒë§Œ ì¢‹ì€ ì‹ ê·œ ë§¤ì¥": f"""
[ë°ì´í„° ê¸°ë°˜ ì „ëµ ê·¼ê±°]
- ì‹ ê·œ ê³ ê° ë¹„ìœ¨: {target_store.get('MCT_UE_CLN_NEW_RAT', 0):.1f}% (60% ì´ˆê³¼), ìš´ì˜ ê¸°ê°„: {translate_metric('tenure', target_store.get('MCT_OPE_MS_CN'))} -> ì²« ë°©ë¬¸ì€ ë§ì§€ë§Œ ì¬ë°©ë¬¸ ì „í™˜ìœ¨ ë‚®ìŒ
[êµ¬ì²´ì  ì‹¤í–‰ ë°©ì•ˆ]
1. 'ì²« ë§Œë‚¨ ê°ì¸': ì²« ë°©ë¬¸ 100% ëŒ€ìƒ "ë‹¤ìŒ ë°©ë¬¸ ì‹œ ëŒ€í‘œë©”ë‰´ 1ê°œ ë¬´ë£Œ" ì¿ í° ì¦ì • (ìœ íš¨ê¸°ê°„ 7ì¼)
2. 'ë‹¨ê³¨ ë„¤ë¹„ê²Œì´ì…˜': 2-3íšŒì°¨ ë°©ë¬¸ ê³ ê° ëŒ€ìƒ "ì‚¬ì¥ë‹˜ ì¶”ì²œ ìˆ¨ê²¨ì§„ ë©”ë‰´ ì¡°í•©" ì•ˆë‚´, VIP ì „ìš© ë©”ë‰´ ì œê³µ
3. 'ì¬ë°©ë¬¸ ë™ê¸° ë¶€ì—¬': ì›”ê°„ "ë‹¨ê³¨ ì „í™˜ ì´ë²¤íŠ¸", ì—°ì† ë°©ë¬¸ ëˆ„ì  í˜œíƒ (3íšŒâ†’5íšŒâ†’10íšŒ ì°¨ë“±)
""",
                "ì¬ë°©ë¬¸í•˜ê¸°ì—” ë¶€ë‹´ìŠ¤ëŸ¬ìš´ ê°€ê²©": f"""
[ë°ì´í„° ê¸°ë°˜ ì „ëµ ê·¼ê±°]
- ê°ë‹¨ê°€ ìˆ˜ì¤€: {translate_metric('level', target_store.get('RC_M1_AV_NP_AT'))}, ì„±ê³µ ê·¸ë£¹ ëŒ€ë¹„ ê²©ì°¨: {analysis_results['price_competitiveness']['gap']:.2f}ì  -> ê°€ê²© ëŒ€ë¹„ ê°€ì¹˜ ì¸ì‹ ë¶€ì¡±
[êµ¬ì²´ì  ì‹¤í–‰ ë°©ì•ˆ]
1. 'ë””ì½”ì´ íš¨ê³¼' ë©”ë‰´ ì¬êµ¬ì„±: ëŒ€í‘œë©”ë‰´ ì˜† "ì‹¤ì† ë©”ë‰´"(ì–‘ 80%, ê°€ê²© 60%) ë°°ì¹˜ (ë©”ë‰´íŒ: ê³ ê°€â†’ì‹¤ì†â†’ì¼ë°˜ ìˆœ)
2. 'ê°€ì¹˜ë¶€ê°€í˜• ë²ˆë“¤ë§': ë©”ì¸ ì£¼ë¬¸ ì‹œ ë§ˆì§„ ë†’ì€ ìŒë£Œ/ì‚¬ì´ë“œ ë¬´ë£Œ ì¦ì •, "ì˜¤ëŠ˜ì˜ íŠ¹ë³„ ì¡°í•©" 20% í• ì¸ ("ì´ ê°€ì¹˜ OOì› â†’ OOì›" í‘œì‹œ)
3. 'ê°€ê²© íˆ¬ëª…ì„±' ë§ˆì¼€íŒ…: ë¹„ìš© êµ¬ì¡° ê³µê°œ, "ì™œ ì´ ê°€ê²©ì¸ê°€?" ìŠ¤í† ë¦¬í…”ë§, ë¦¬ë·°ì— ê°€ì„±ë¹„ ë§Œì¡±ë„ ìœ ë„
""",
                "ë™ë„¤ ì£¼ë¯¼ì„ ì‚¬ë¡œì¡ì§€ ëª»í•˜ëŠ” ë§¤ì¥": f"""
[ë°ì´í„° ê¸°ë°˜ ì „ëµ ê·¼ê±°]
- ê±°ì£¼ ê³ ê° ë¹„ìœ¨: {analysis_results['audience_alignment'].get('target', 0):.1f}%, ì„±ê³µ ê·¸ë£¹ ëŒ€ë¹„ ê²©ì°¨: {analysis_results['audience_alignment']['gap']:.1f}%p -> ë™ë„¤ ì£¼ë¯¼ í™•ë³´ ì‹¤íŒ¨, ë‹¨ê³¨ ê¸°ë°˜ ì•½í•¨
[êµ¬ì²´ì  ì‹¤í–‰ ë°©ì•ˆ]
1. 'ìš°ë¦¬ ë™ë„¤ ë©¤ë²„ì‹­': ì£¼ë¯¼ ì¸ì¦ ì‹œ í˜œíƒ(í¬ì¸íŠ¸ 2ë°°, ì›”ê°„ ìŠ¤í˜ì…œ ë©”ë‰´), ì£¼ë¯¼ ì „ìš© ì´ë²¤íŠ¸("ë™ë„¤ ë§›ì§‘ íˆ¬ì–´")
2. 'ë¡œì»¬ ì¸í”Œë£¨ì–¸ì„œ' íŒŒíŠ¸ë„ˆì‹­: ì§€ì—­ ë§˜ì¹´í˜ ìš´ì˜ì§„/ë§›ì§‘ ë¸”ë¡œê±° ì´ˆì²­ ì‹œì‹íšŒ, ì§€ì—­ SNS ê·¸ë£¹ ì†Œí†µ
3. 'ì§€ì—­ ì‚¬íšŒ ê¸°ì—¬': ë™ë„¤ í–‰ì‚¬ ì°¸ì—¬, ì§€ì—­ ë‹¨ì²´ í›„ì›, ì§€ì—­ ì·¨ì•½ê³„ì¸µ í• ì¸
""",
                "ë°°ë‹¬ ì±„ë„ ë¶€ì¬": f"""
[ë°ì´í„° ê¸°ë°˜ ì „ëµ ê·¼ê±°]
- ë°°ë‹¬ ë§¤ì¶œ ë¹„ì¤‘: {target_delivery_ratio_avg:.1f}%, ì„±ê³µ ê·¸ë£¹ ëŒ€ë¹„ ê²©ì°¨: {analysis_results['channel_expansion']['gap']:.1f}%p -> ì˜¨ë¼ì¸ ê³ ê° ì ‘ì  ë¶€ì¬
[êµ¬ì²´ì  ì‹¤í–‰ ë°©ì•ˆ]
1. 'ë°°ë‹¬ì•± ìµœì í™”': ì£¼ìš” ë°°ë‹¬ì•± 3ê°œ ì´ìƒ ë“±ë¡, ë°°ë‹¬ ì „ìš© ë©”ë‰´/ì‚¬ì´ì¦ˆ êµ¬ì„±, ë¦¬ë·° 4.5ì  ì´ìƒ ê´€ë¦¬
2. 'O2O ì—°ê³„ í”„ë¡œëª¨ì…˜': ë°°ë‹¬ ì£¼ë¬¸ ì‹œ ë§¤ì¥ ì¿ í° ë™ë´‰, ë§¤ì¥ ë°©ë¬¸ ì‹œ ë°°ë‹¬ ì¿ í° ì œê³µ
3. 'ë°°ë‹¬ ë°ì´í„° í™œìš©': ì¸ê¸° ë°°ë‹¬ ë©”ë‰´ ì˜¤í”„ë¼ì¸ íƒ€ì„ ì„¸ì¼, ë°°ë‹¬ íŒ¨í„´ ë¶„ì„ í›„ í”¼í¬íƒ€ì„ ì˜ˆì¸¡/ì¬ê³  ê´€ë¦¬
""",
                "ì´ì²´ì  ë§ˆì¼€íŒ… ë¶€ì¬": f"""
[ë°ì´í„° ê¸°ë°˜ ì „ëµ ê·¼ê±°]
- ê°€ê²© ê²½ìŸë ¥({analysis_results['price_competitiveness']['gap']:.2f}ì ), ê±°ì£¼ ê³ ê°({analysis_results['audience_alignment']['gap']:.1f}%p), ë°°ë‹¬ ì±„ë„({analysis_results['channel_expansion']['gap']:.1f}%p) ëª¨ë‘ ë¶€ì¡± -> ë§ˆì¼€íŒ…/ê³ ê°ê´€ë¦¬ ì‹œìŠ¤í…œ ë¶€ì¬
[êµ¬ì²´ì  ì‹¤í–‰ ë°©ì•ˆ]
1. 'ê³ ê° ìì‚°í™”': ì¹´ì¹´ì˜¤í†¡ ì±„ë„ ê°œì„¤("ì¹œêµ¬ ì¶”ê°€ ì‹œ 1+1 ì¿ í°"), ê³ ê° DB êµ¬ì¶•(ë°©ë¬¸ ë¹ˆë„, ì„ í˜¸ ë©”ë‰´ ë“±) ë° ì„¸ë¶„í™”(VIP/ì¼ë°˜/ì‹ ê·œ)
2. 'ìë™í™” CRM': ê°€ì… 1ë‹¬ í›„(ê°ì‚¬ ì¿ í°), ìƒì¼ ë‹¹ì¼(ìƒì¼ ì¿ í°), 2ì£¼ ë¯¸ë°©ë¬¸(ë¦¬ë§ˆì¸ë“œ ì¿ í°), ê³„ì ˆë³„(ì‹œì¦Œ ì¿ í°/ì•Œë¦¼) ìë™ ë°œì†¡
3. 'í†µí•© ë§ˆì¼€íŒ… í”Œë«í¼': ì˜¨/ì˜¤í”„ë¼ì¸ í†µí•© í¬ì¸íŠ¸, ê³ ê° ì—¬ì •(ì¸ì§€â†’ê´€ì‹¬â†’ë°©ë¬¸â†’ì¬ë°©ë¬¸â†’ì¶”ì²œ) ì¶”ì , ë°ì´í„° ê¸°ë°˜ ê°œì¸í™” ë§ˆì¼€íŒ…
"""
            }
            
            selected_persona_strategy_details = persona_strategies.get(persona, "ë§ì¶¤í˜• ì „ëµ ìˆ˜ë¦½ì´ í•„ìš”í•©ë‹ˆë‹¤.")
            
            # --- Stage 4 í”„ë¡¬í”„íŠ¸ ìˆ˜ì • ---
            stage4_prompt = f"""
ë„ˆëŠ” ì‚¬ì¥ë‹˜ì˜ ì‹¤í–‰ì„ ë•ëŠ” **'AI ë§ˆì¼€íŒ… ì•¡ì…˜ í”Œë˜ë„ˆ'**ë‹¤.
ì•ì„œ ë¶„ì„ëœ Stage 1~3ì˜ ë°ì´í„°ë¥¼ ë°”íƒ•ìœ¼ë¡œ, ì‚¬ì¥ë‹˜ì´ **'ê·¸ë˜ì„œ ë‹¹ì¥ ë­˜ í•´ì•¼ í•˜ëŠ”ì§€'** ëª…í™•íˆ ì•Œ ìˆ˜ ìˆë„ë¡ êµ¬ì²´ì ì¸ ì•¡ì…˜ í”Œëœì„ ì œì‹œí•´ì•¼ í•œë‹¤.
ì¶”ìƒì ì¸ ì¡°ì–¸ ëŒ€ì‹ , **ë°ì´í„°ì— ê·¼ê±°í•œ ì‹¤í–‰ ê°€ëŠ¥í•œ ì•„ì´í…œ**ì„ ëª…í™•í•˜ê²Œ ì œì‹œí•˜ë¼.

**[Stage 1~3 ë¶„ì„ ê²°ê³¼ ìš”ì•½]**
* **ì§„ë‹¨ëœ ë¬¸ì œ ìœ í˜• (í˜ë¥´ì†Œë‚˜):** '{persona}'
* **ê°€ì¥ ì‹œê¸‰í•œ ê°œì„  ì§€í‘œ:** ê°€ê²© ê²½ìŸë ¥({analysis_results['price_competitiveness']['gap']:.2f}ì ), ê±°ì£¼ ê³ ê°({analysis_results['audience_alignment']['gap']:.1f}%p), ë°°ë‹¬ ì±„ë„({analysis_results['channel_expansion']['gap']:.1f}%p) ì¤‘ ê°€ì¥ ê²©ì°¨ê°€ í° í•­ëª©
* **ê²€ì¦ëœ ì„±ê³µ ê³µì‹ (í•µì‹¬ ì „ëµ):** '{key_strategy}' (í•µì‹¬ ì„±ê³µ ë³€ìˆ˜: '{key_factor}')
* **í˜„ì¬ ì¬ë°©ë¬¸ìœ¨:** {target_revisit_rate:.2f}% (ëª©í‘œ: 30% ì´ìƒ)

**[OUTPUT INSTRUCTION]**
ì•„ë˜ í˜•ì‹ì— ë§ì¶° **ì‚¬ì¥ë‹˜ ë§ì¶¤í˜• ì¬ë°©ë¬¸ìœ¨ ê°œì„  ì•¡ì…˜ í”Œëœ**ì„ êµ¬ì²´ì ìœ¼ë¡œ ì‘ì„±í•˜ë¼.

---
**ğŸ¯ ì‚¬ì¥ë‹˜ ë§ì¶¤í˜• ì•¡ì…˜ í”Œëœ: '{persona}' ë¬¸ì œ í•´ê²° ì „ëµ**

(ì‚¬ì¥ë‹˜ ê°€ê²Œê°€ '{persona}' ìœ í˜•ìœ¼ë¡œ ì§„ë‹¨ë˜ì—ˆìœ¼ë¯€ë¡œ, ì´ ë¬¸ì œë¥¼ í•´ê²°í•˜ê¸° ìœ„í•œ **ê°€ì¥ íš¨ê³¼ì ì¸ 1~2ê°€ì§€ í•µì‹¬ ì•¡ì…˜ ì•„ì´í…œ**ì„ ì•„ë˜ì™€ ê°™ì´ ì œì•ˆí•©ë‹ˆë‹¤. ì´ëŠ” '{key_strategy}'ë¼ëŠ” ê²€ì¦ëœ ì„±ê³µ ê³µì‹ì„ ì ìš©í•œ ê²ƒì…ë‹ˆë‹¤.)

{selected_persona_strategy_details}

---
**ğŸ’¡ ì¶”ê°€ ì•¡ì…˜ ì•„ì´í…œ: ì„±ê³µ ê·¸ë£¹ ë”°ë¼ì¡ê¸°**

(ìœ„ í•µì‹¬ ì•¡ì…˜ ì™¸ì—ë„, Stage 2 ë¶„ì„ ê²°ê³¼ ì„±ê³µ ê·¸ë£¹ ëŒ€ë¹„ ê²©ì°¨ê°€ ìˆì—ˆë˜ ì§€í‘œë¥¼ ê°œì„ í•˜ê¸° ìœ„í•œ **ì¶”ê°€ì ì¸ ì•¡ì…˜ ì•„ì´í…œ 1~2ê°€ì§€**ë¥¼ ì œì•ˆí•©ë‹ˆë‹¤.)

* **[ê°œì„  í•„ìš” ì§€í‘œ 1]** (ì˜ˆ: ê±°ì£¼ ê³ ê° í™•ë³´)
    * **ì•¡ì…˜ ì•„ì´í…œ:** (ì˜ˆ: 'ìš°ë¦¬ ë™ë„¤ ë©¤ë²„ì‹­' ë„ì… - ì£¼ë¯¼ ì¸ì¦ ì‹œ í¬ì¸íŠ¸ 2ë°° ì ë¦½)
    * **ë°ì´í„° ê·¼ê±°:** (ì˜ˆ: í˜„ì¬ ê±°ì£¼ ê³ ê° ë¹„ìœ¨ì´ ì„±ê³µ ê·¸ë£¹ë³´ë‹¤ {analysis_results['audience_alignment']['gap']:.1f}%p ë‚®ìœ¼ë¯€ë¡œ, ì§€ì—­ ì£¼ë¯¼ ëŒ€ìƒ í˜œíƒ ê°•í™” í•„ìš”)

* **[ê°œì„  í•„ìš” ì§€í‘œ 2]** (ì˜ˆ: ë°°ë‹¬ ì±„ë„ í™œì„±í™”)
    * **ì•¡ì…˜ ì•„ì´í…œ:** (ì˜ˆ: ì£¼ìš” ë°°ë‹¬ì•± 2ê³³ ì´ìƒ ì…ì  ë° ë°°ë‹¬ ì „ìš© '1ì¸ ì„¸íŠ¸ ë©”ë‰´' ì¶œì‹œ)
    * **ë°ì´í„° ê·¼ê±°:** (ì˜ˆ: í˜„ì¬ ë°°ë‹¬ ë¯¸ìš´ì˜/ì €ì¡° ({analysis_results['channel_expansion']['gap']:.1f}%p ê²©ì°¨)í•˜ë¯€ë¡œ, ì˜¨ë¼ì¸ ì ‘ì  í™•ëŒ€ í•„ìš”)

---
**ğŸ“… 4ì£¼ ì‹¤í–‰ ë¡œë“œë§µ & ì˜ˆìƒ íš¨ê³¼**

(ì‚¬ì¥ë‹˜ì´ ë°”ë¡œ ì‹¤í–‰í•˜ì‹¤ ìˆ˜ ìˆë„ë¡, ìœ„ ì•¡ì…˜ ì•„ì´í…œë“¤ì„ **4ì£¼ê°„ì˜ ë¡œë“œë§µ**ìœ¼ë¡œ ì •ë¦¬í–ˆìŠµë‹ˆë‹¤.)

* **1ì£¼ì°¨:** [ê°€ì¥ ë¨¼ì € í•´ì•¼ í•  í•µì‹¬ ì•¡ì…˜ 1ê°€ì§€ êµ¬ì²´ì ìœ¼ë¡œ ëª…ì‹œ] (ì˜ˆ: 'ì‹¤ì† ë©”ë‰´' ê°œë°œ ë° ë©”ë‰´íŒ ë””ìì¸ ë³€ê²½)
* **2ì£¼ì°¨:** [ê·¸ ë‹¤ìŒ ì‹¤í–‰í•  ì•¡ì…˜ 1ê°€ì§€ êµ¬ì²´ì ìœ¼ë¡œ ëª…ì‹œ] (ì˜ˆ: ì¹´ì¹´ì˜¤í†¡ ì±„ë„ ê°œì„¤ ë° 'ì¹œêµ¬ ì¶”ê°€' ì´ë²¤íŠ¸ ì‹œì‘)
* **3-4ì£¼ì°¨:** [ë‚˜ë¨¸ì§€ ì•¡ì…˜ ì‹¤í–‰ ë° 1-2ì£¼ì°¨ ì„±ê³¼ ì¸¡ì • ì‹œì‘] (ì˜ˆ: ë°°ë‹¬ì•± ì…ì  ì‹ ì²­ / ì¿ í° ì‚¬ìš©ë¥ , ì±„ë„ ì¹œêµ¬ ìˆ˜ ë“± ë°ì´í„° í™•ì¸)

* **ì˜ˆìƒ íš¨ê³¼:** (ìœ„ ë¡œë“œë§µì„ ê¾¸ì¤€íˆ ì‹¤í–‰í•˜ì‹œë©´, 2-3ê°œì›” ë‚´ ì¬ë°©ë¬¸ìœ¨ {target_revisit_rate:.2f}% â†’ **30% ë‹¬ì„±** ë° **ì›” ë§¤ì¶œ 20-30% ì¦ê°€**ë¥¼ ê¸°ëŒ€í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. LTV í–¥ìƒìœ¼ë¡œ ì¥ê¸°ì ì¸ ì•ˆì • ë§¤ì¶œ í™•ë³´ì—ë„ ê¸°ì—¬í•  ê²ƒì…ë‹ˆë‹¤.)
"""
            # í¬ë§·íŒ…ëœ í”„ë¡¬í”„íŠ¸ ë¬¸ìì—´ì„ ë°˜í™˜
            return stage4_prompt
            
        # --- ìµœì¢… ë¦¬í¬íŠ¸ ìƒì„± ë¡œì§ ë³€ê²½ ---
        # 1. Stage 3 ë¶„ì„ ê²°ê³¼ ìƒì„±
        stage3_analysis = get_stage3_analysis(persona, key_factor, key_strategy, analysis_results)
        
        # 2. Stage 4 í”„ë¡¬í”„íŠ¸ ìƒì„± (LLM í˜¸ì¶œì€ ì•„ì§ ì•ˆ í•¨)
        stage4_prompt_for_llm = get_stage4_integrated_strategy(persona, key_factor, key_strategy, analysis_results)

        # 3. Stage 4 í”„ë¡¬í”„íŠ¸ë¥¼ LLMì— ë³´ë‚´ ìµœì¢… ì•¡ì…˜ í”Œëœ ìƒì„±
        stage4_llm_response = call_gemini_llm(stage4_prompt_for_llm)

        # 4. ìµœì¢… ë¦¬í¬íŠ¸ ì¡°í•©
        final_report = f"""
 AI í•˜ì´ë¸Œë¦¬ë“œ ì „ëµ ì»¨ì„¤íŒ… - '{store_id}' ê°€ë§¹ì  ë¶„ì„ ë¦¬í¬íŠ¸
{basic_info_content}

---------- [STAGE 1] ìš°ë¦¬ ê°€ê²Œ í˜„í™© ë¸Œë¦¬í•‘ ----------
  - ì—…ì¢… / ìƒê¶Œ: {industry} / {area_name}
  - ìš´ì˜ ê¸°ê°„: {translate_metric('tenure', target_store.get('MCT_OPE_MS_CN'))}
  - í˜„ì¬ ì¬ë°©ë¬¸ìœ¨ (ì›” í‰ê· ): {target_revisit_rate:.2f}% (âš ï¸ ê°œì„  í•„ìš”)
  - ë§¤ì¶œì•¡ ìˆ˜ì¤€ (ìµœì‹ ì›” ê¸°ì¤€): {translate_metric('level', target_store.get('RC_M1_SAA'))}
  - ê°ë‹¨ê°€ ìˆ˜ì¤€ (ìµœì‹ ì›” ê¸°ì¤€): {translate_metric('level', target_store.get('RC_M1_AV_NP_AT'))}

---------- [STAGE 2] ì¬ë°©ë¬¸ìœ¨ í•µì‹¬ ë™ì¸(Key Drivers) 3ì°¨ì› ë¶„ì„ ----------
ê°™ì€ '{industry}' ì—…ì¢… '{area_name}' ìƒê¶Œ ë‚´ ì„±ê³µ ê·¸ë£¹ê³¼ 3ê°€ì§€ í•µì‹¬ ë™ì¸ì„ ë¹„êµí•œ ê²°ê³¼ì…ë‹ˆë‹¤.

  â‘  ê°€ê²© ê²½ìŸë ¥ (ê°ë‹¨ê°€)
    - ë‚´ ê°€ê²Œ ìˆ˜ì¤€ (ìµœì‹ ì›”): {translate_metric('level', target_store.get('RC_M1_AV_NP_AT'))} (ì›”ë³„ í‰ê· ì ìˆ˜: {analysis_results['price_competitiveness']['target']:.2f})
    - ì„±ê³µ ê·¸ë£¹ í‰ê· : {score_to_level_text(analysis_results['price_competitiveness']['peer_avg'])} (ì›”ë³„ í‰ê· ì ìˆ˜: {analysis_results['price_competitiveness']['peer_avg']:.2f})
    - ê²©ì°¨: {analysis_results['price_competitiveness']['gap']:.2f}ì 
    - â¡ï¸ AI ë¶„ì„: {'ì„±ê³µ ê·¸ë£¹ë³´ë‹¤ ê°ë‹¨ê°€ê°€ ë†’ì•„(ì ìˆ˜ê°€ ë‚®ì•„), ê³ ê°ì´ ì¬ë°©ë¬¸í•˜ê¸°ì— ë¶€ë‹´ì„ ëŠë‚„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.' if analysis_results['price_competitiveness'].get('gap', 0) < 0 else 'ê°ë‹¨ê°€ ìˆ˜ì¤€ì€ ê²½ìŸ ê·¸ë£¹ ëŒ€ë¹„ ì–‘í˜¸í•©ë‹ˆë‹¤. ê°€ê²©ë³´ë‹¤ëŠ” ë‹¤ë¥¸ ìš”ì†Œë¥¼ ë¨¼ì € ê°œì„ í•´ì•¼ í•©ë‹ˆë‹¤.'}

  â‘¡ í•µì‹¬ ê³ ê°ì¸µ (ê±°ì£¼ì)
    - ë‚´ ê°€ê²Œ ë¹„ìœ¨ (ì›” í‰ê· ): {analysis_results['audience_alignment'].get('target', 0):.1f}%
    - ì„±ê³µ ê·¸ë£¹ í‰ê· : {analysis_results['audience_alignment'].get('peer_avg', 0):.1f}%
    - ê²©ì°¨: {analysis_results['audience_alignment']['gap']:.1f}%p
    - â¡ï¸ AI ë¶„ì„: {f"ë™ë„¤ ì£¼ë¯¼ ê³ ê°ì„ '{abs(analysis_results['audience_alignment']['gap']):.1f}%p' ë§Œí¼ ë” í™•ë³´í•  ìˆ˜ ìˆëŠ” ê¸°íšŒê°€ ìˆìŠµë‹ˆë‹¤." if analysis_results['audience_alignment'].get('gap', 0) < 0 else 'ë™ë„¤ ì£¼ë¯¼ ê³ ê° í™•ë³´ëŠ” ì–‘í˜¸í•œ ìˆ˜ì¤€ì…ë‹ˆë‹¤.'}
        
  â‘¢ ì±„ë„ í™•ì¥ì„± (ë°°ë‹¬)
    - ë‚´ ê°€ê²Œ ë°°ë‹¬ë§¤ì¶œ ë¹„ì¤‘ (ì›” í‰ê· ): {target_delivery_ratio_avg:.1f}% {'(ë°°ë‹¬ ë¯¸ìš´ì˜)' if is_delivery_not_operated else ''}
    - ì„±ê³µ ê·¸ë£¹ í‰ê· : {analysis_results['channel_expansion'].get('peer_avg', 0):.1f}%
    - ê²©ì°¨: {analysis_results['channel_expansion']['gap']:.1f}%p
    - â¡ï¸ AI ë¶„ì„: {'ë°°ë‹¬ì„ ìš´ì˜í•˜ì§€ ì•ŠëŠ” ê²ƒìœ¼ë¡œ í™•ì¸ë©ë‹ˆë‹¤.' if is_delivery_not_operated else (f"ì„±ê³µ ê·¸ë£¹ ëŒ€ë¹„ ë°°ë‹¬ ë§¤ì¶œ ë¹„ì¤‘ì´ '{abs(analysis_results['channel_expansion']['gap']):.1f}%p' ë‚®ì•„, ì˜¨ë¼ì¸ ì ì¬ ê³ ê°ì„ ë†“ì¹˜ê³  ìˆìŠµë‹ˆë‹¤." if analysis_results['channel_expansion'].get('gap', 0) < 0 else 'ë°°ë‹¬ ì±„ë„ì€ ê²½ìŸë ¥ ìˆê²Œ ìš´ì˜ë˜ê³  ìˆìŠµë‹ˆë‹¤.')}

ğŸ“Š AI ì¢…í•© ì§„ë‹¨: ìœ„ 3ê°€ì§€ ë™ì¸ì„ ì¢…í•© ë¶„ì„í•œ ê²°ê³¼, ì‚¬ì¥ë‹˜ ê°€ê²Œì˜ í˜„ì¬ ê°€ì¥ ì‹œê¸‰í•œ ê°œì„  ê³¼ì œëŠ” '{persona}' ìœ í˜•ì— í•´ë‹¹í•©ë‹ˆë‹¤.

---------- [STAGE 3] í˜ë¥´ì†Œë‚˜ & í•µì‹¬ì„±ê³µì „ëµ ìƒì„¸ ë¶„ì„ ----------
{stage3_analysis}

---------- [STAGE 4] AI ë§ˆì¼€íŒ… ì•¡ì…˜ í”Œëœ ----------
{stage4_llm_response}

======================================================================
"""
        # 2. í†µí•©ëœ ë¦¬í¬íŠ¸ í•˜ë‚˜ë§Œ ë°˜í™˜
        return final_report

    except Exception as e:
        import traceback
        error_details = traceback.format_exc()
        return f"""ğŸš¨ ì¬ë°©ë¬¸ìœ¨ ë¶„ì„ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.

**ì˜¤ë¥˜ ìƒì„¸ ì •ë³´:**
- ì˜¤ë¥˜ ìœ í˜•: {type(e).__name__}
- ì˜¤ë¥˜ ë©”ì‹œì§€: {str(e)}
- ê°€ë§¹ì  ID: {store_id}

**í•´ê²° ë°©ë²•:**
1. ê°€ë§¹ì  IDê°€ ì˜¬ë°”ë¥¸ì§€ í™•ì¸í•´ì£¼ì„¸ìš”
2. ë°ì´í„°ë² ì´ìŠ¤ì— í•´ë‹¹ ê°€ë§¹ì  ì •ë³´ê°€ ìˆëŠ”ì§€ í™•ì¸í•´ì£¼ì„¸ìš”
3. ë¬¸ì œê°€ ì§€ì†ë˜ë©´ ê´€ë¦¬ìì—ê²Œ ë¬¸ì˜í•´ì£¼ì„¸ìš”

**ê¸°ìˆ ì  ì„¸ë¶€ì‚¬í•­:**
{error_details}"""

# =============================================================================
# ëª¨ë¸ 3: ìš”ì‹ì—…ì¢… ê°€ë§¹ì ì˜ ì „ë°©ìœ„ ê°•ì /ì•½ì  ë¶„ì„ ë° ì†”ë£¨ì…˜ ì œì•ˆ
# =============================================================================

def apply_emphasis(score):
    """ì ìˆ˜ë¥¼ 0-100 ë²”ìœ„ì—ì„œ ì–‘ ê·¹ë‹¨ìœ¼ë¡œ ìŠ¤íŠ¸ë ˆì¹­í•˜ì—¬ ì°¨ì´ë¥¼ ëª…í™•í•˜ê²Œ ë§Œë“­ë‹ˆë‹¤."""
    x = (score - 50) / 50
    y = np.sign(x) * (abs(x) ** 0.7)
    return max(0, min(100, (y * 50) + 50))

def get_percentile_score(store_value, benchmark_series, higher_is_better=True):
    """ê²½ìŸ ê·¸ë£¹ ë‚´ ë°±ë¶„ìœ„ ìˆœìœ„ë¥¼ 0-100ì  ì²™ë„ì˜ 'ê²½ì˜ ì ìˆ˜'ë¡œ ë³€í™˜í•˜ê³  ê°€ì¤‘ì¹˜ë¥¼ ì ìš©"""
    if pd.isna(store_value) or benchmark_series.empty:
        return 50
    combined = pd.concat([benchmark_series, pd.Series([store_value])])
    percentile = combined.rank(pct=True, na_option='bottom').iloc[-1]
    raw_score = percentile * 100 if higher_is_better else (1 - percentile) * 100
    return apply_emphasis(raw_score)

def parse_segment(segment_name):
    """ì„¸ê·¸ë¨¼íŠ¸ ì´ë¦„ì„ íŒŒì‹±í•˜ì—¬ ì„±ë³„ê³¼ ì—°ë ¹ ì •ë³´ ì¶”ì¶œ"""
    parts = segment_name.replace('M12_', '').replace('_RAT', '').split('_')
    return {'name': segment_name, 'gender': parts[0], 'age': parts[1]}

def get_age_tier(age_str):
    """ì—°ë ¹ëŒ€ë¥¼ ìˆ«ìë¡œ ë³€í™˜"""
    tiers = {'1020': 1, '30': 2, '40': 3, '50': 4, '60': 5}
    return tiers.get(age_str, 0)

def calculate_advanced_match_score(area_top2_names, store_top2_names):
    """'Top 2 ë¹„êµ ë° ìœ ì‚¬ë„ ë³´ë„ˆìŠ¤' ë¡œì§ìœ¼ë¡œ ì í•©ë„ ì ìˆ˜ ê³„ì‚°"""
    intersection_count = len(set(area_top2_names) & set(store_top2_names))
    
    base_score = 0
    if intersection_count == 2:
        base_score = 85
    elif intersection_count == 1:
        base_score = 45
    else:
        base_score = 5

    bonus_score = 0
    non_matching_area = [parse_segment(s) for s in set(area_top2_names) - set(store_top2_names)]
    non_matching_store = [parse_segment(s) for s in set(store_top2_names) - set(store_top2_names)]

    for s_seg in non_matching_store:
        for a_seg in non_matching_area:
            if s_seg['age'] == a_seg['age']:
                bonus_score = max(bonus_score, 10)
            if s_seg['gender'] == a_seg['gender'] and abs(get_age_tier(s_seg['age']) - get_age_tier(a_seg['age'])) == 1:
                bonus_score = max(bonus_score, 5)
    
    return max(0, min(100, base_score + bonus_score))

@tool
def store_strength_weakness_tool(store_id: str, df_all_join: pd.DataFrame) -> str:
    """
    ìš”ì‹ì—…ì¢… ê°€ë§¹ì ì˜ ì „ë°˜ì ì¸ ê±´ê°• ìƒíƒœë¥¼ ë‹¤ê°ë„ë¡œ ë¶„ì„í•˜ì—¬, 
    ê²½ìŸ ê·¸ë£¹ ëŒ€ë¹„ ëª…í™•í•œ ê°•ì ê³¼ ì•½ì ì„ ì§„ë‹¨í•˜ê³ , 
    ì´ë¥¼ ë°”íƒ•ìœ¼ë¡œ ê°œì„  ì†”ë£¨ì…˜ì„ ì œì•ˆí•˜ëŠ” ë„êµ¬.
    ê°€ê²Œì˜ 'ë¬¸ì œì ', 'ê°€ì¥ í° ë¬¸ì œì ' ì— ëŒ€í•œ í¬ê´„ì ì¸ ì§„ë‹¨ì´ í•„ìš”í•  ë•Œ ì‚¬ìš©ëœë‹¤.
    
    Args:
        store_id: ë¶„ì„í•  ê°€ë§¹ì  ID
        df_all_join: ì „ì²´ JOIN ë°ì´í„°
    
    Returns:
        ê°•ì /ì•½ì  ë¶„ì„ ë° ê°œì„  ì†”ë£¨ì…˜ ë¦¬í¬íŠ¸
    """
    try:
        # 1. ê³µí†µ í—¬í¼ í•¨ìˆ˜ í˜¸ì¶œ (ë°˜í™˜ ë³€ìˆ˜ëª… ë³€ê²½)
        basic_info_content, latest_store_data = _get_store_basic_info(store_id, df_all_join)
        
        if latest_store_data is None:
            return basic_info_content # ì˜¤ë¥˜ ë©”ì‹œì§€ëŠ” ê·¸ëŒ€ë¡œ ë°˜í™˜

        store_df = df_all_join[df_all_join['ENCODED_MCT'] == store_id].tail(12)
        category, commercial_area = latest_store_data['ì—…ì¢…_ì •ê·œí™”2_ëŒ€ë¶„ë¥˜'], latest_store_data['HPSN_MCT_BZN_CD_NM']
        
        if pd.notna(commercial_area):
            benchmark_type = "ë™ì¼ ìƒê¶Œ ë‚´ ë™ì¢…ì—…ê³„"
            benchmark_df = df_all_join[(df_all_join['ì—…ì¢…_ì •ê·œí™”2_ëŒ€ë¶„ë¥˜'] == category) & (df_all_join['HPSN_MCT_BZN_CD_NM'] == commercial_area)]
        else:
            benchmark_type = "ë¹„ìƒê¶Œ ì§€ì—­ì˜ ë™ì¢…ì—…ê³„"
            benchmark_df = df_all_join[(df_all_join['ì—…ì¢…_ì •ê·œí™”2_ëŒ€ë¶„ë¥˜'] == category) & (df_all_join['HPSN_MCT_BZN_CD_NM'].isna())]
        
        # ë¶„ì„í•  ì§€í‘œë“¤ (ì‹¤ì œ ì¡´ì¬í•˜ëŠ” ì»¬ëŸ¼ëª…ìœ¼ë¡œ ìˆ˜ì •)
        metrics_to_analyze = [
            {'name': 'ë§¤ì¶œ ê·œëª¨', 'col': 'RC_M1_SAA', 'type': 'tier', 'higher_is_better': False},
            {'name': 'ìœ ë‹ˆí¬ ê³ ê° ìˆ˜', 'col': 'RC_M1_UE_CUS_CN', 'type': 'tier', 'higher_is_better': False},
            {'name': 'ê³ ê°ë‹¹ ì§€ì¶œì•¡(ê°ë‹¨ê°€)', 'col': 'RC_M1_AV_NP_AT', 'type': 'tier', 'higher_is_better': False},
            {'name': 'ì—…ì¢… í‰ê·  ëŒ€ë¹„ ë§¤ì¶œ', 'col': 'M1_SME_RY_SAA_RAT', 'type': 'ratio', 'higher_is_better': True},
            {'name': 'ì‹ ê·œ ê³ ê° ë¹„ìœ¨', 'col': 'MCT_UE_CLN_NEW_RAT', 'type': 'ratio', 'higher_is_better': True},
            {'name': 'ì¬ë°©ë¬¸ ê³ ê° ë¹„ìœ¨', 'col': 'MCT_UE_CLN_REU_RAT', 'type': 'ratio', 'higher_is_better': True},
            {'name': 'ë°°ë‹¬ ë§¤ì¶œ ë¹„ìœ¨', 'col': 'DLV_SAA_RAT', 'type': 'ratio', 'higher_is_better': True},
            {'name': 'ê±°ì£¼ ê³ ê° ë¹„ìœ¨', 'col': 'RC_M1_SHC_RSD_UE_CLN_RAT', 'type': 'ratio', 'higher_is_better': True},
            {'name': 'ì§ì¥ì¸ ê³ ê° ë¹„ìœ¨', 'col': 'RC_M1_SHC_WP_UE_CLN_RAT', 'type': 'ratio', 'higher_is_better': True},
            {'name': 'ìœ ë™ì¸êµ¬ ê³ ê° ë¹„ìœ¨', 'col': 'RC_M1_SHC_FLP_UE_CLN_RAT', 'type': 'ratio', 'higher_is_better': True},
        ]

        # ë°°ë‹¬ ë°ì´í„° í™•ì¸
        has_delivery_data = store_df['DLV_SAA_RAT'].sum() > 0
        if not has_delivery_data:
            metrics_to_analyze = [m for m in metrics_to_analyze if m['name'] != 'ë°°ë‹¬ ë§¤ì¶œ ë¹„ìœ¨']

        # ë²¤ì¹˜ë§ˆí¬ ê¸°ì¤€ ë°ì´í„° ë³€ê²½: ë£¨í”„ ì‹œì‘ ì „ì—, ë²¤ì¹˜ë§ˆí¬ ê·¸ë£¹ì˜ 'ìµœì‹ ' ë°ì´í„°ë§Œ ëª¨ì€ ë°ì´í„°í”„ë ˆì„ì„ ìƒì„±
        benchmark_latest_df = benchmark_df.loc[benchmark_df.groupby('ENCODED_MCT')['TA_YM'].idxmax()]

        all_scores = []
        for metric in metrics_to_analyze:
            if metric['type'] == 'tier':
                # tier (êµ¬ê°„) íƒ€ì… ì§€í‘œ ì²˜ë¦¬
                store_val = get_score_from_raw(latest_store_data[metric['col']])
                benchmark_series = benchmark_latest_df[metric['col']].apply(get_score_from_raw)
                score = get_percentile_score(store_val, benchmark_series.dropna(), metric['higher_is_better'])
                
                # [ìˆ˜ì •] translate_metricì„ ì‚¬ìš©í•˜ì—¬ LLMì´ ì´í•´í•  ìˆ˜ ìˆëŠ” í…ìŠ¤íŠ¸ë¡œ ë³€í™˜
                store_display = translate_metric('level', latest_store_data[metric['col']])
                benchmark_display_mode = "N/A"
                if not benchmark_latest_df.empty and not benchmark_latest_df[metric['col']].mode().empty:
                    benchmark_display_mode = benchmark_latest_df[metric['col']].mode()[0]
                benchmark_display = translate_metric('level', benchmark_display_mode)
                    
            elif metric['type'] == 'ratio':
                # ratio (ë¹„ìœ¨) íƒ€ì… ì§€í‘œ ì²˜ë¦¬
                # [ìˆ˜ì •] ì ìˆ˜ ê³„ì‚°(store_val)ê³¼ í‘œì‹œ(store_display_val)ì˜ ê¸°ì¤€ì„ 'ìµœì‹  ì›”' ë°ì´í„°ë¡œ í†µì¼
                store_val = latest_store_data[metric['col']]
                # [ìˆ˜ì •] ë²¤ì¹˜ë§ˆí¬ë„ 'ìµœì‹  ì›”' ë°ì´í„°(benchmark_latest_df)ë¥¼ ê¸°ì¤€ìœ¼ë¡œ ë³€ê²½ (ê²½ìŸì‚¬ë“¤ì˜ ìµœì‹  ì›” ê°’ ë¦¬ìŠ¤íŠ¸)
                benchmark_series = benchmark_latest_df[metric['col']] 
                
                score = get_percentile_score(store_val, benchmark_series.dropna(), metric['higher_is_better'])
                
                store_display_val = store_val # ì´ë¯¸ ìµœì‹  ê°’ì´ë¯€ë¡œ ê·¸ëŒ€ë¡œ ì‚¬ìš©
                benchmark_display_val = benchmark_series.dropna().mean() # ê²½ìŸì‚¬ ìµœì‹  ê°’ë“¤ì˜ í‰ê· 
                
                store_display = f"{store_display_val:.1f}%" if pd.notna(store_display_val) else "N/A"
                benchmark_display = f"{benchmark_display_val:.1f}%" if pd.notna(benchmark_display_val) else "N/A"
            
            # NaN ê°’ ì²˜ë¦¬
            if pd.isna(score):
                score = 50.0 # ì¤‘ê°„ê°’ìœ¼ë¡œ ì²˜ë¦¬

            all_scores.append({
                'metric': metric['name'], 
                'score': f"{score:.1f}ì ",
                'store_value_display': store_display,
                'benchmark_value_display': benchmark_display,
                'raw_score': score,
                'higher_is_better': metric.get('higher_is_better', True) # ë‚˜ì¤‘ LLM í”„ë¡¬í”„íŠ¸ì— í™œìš©
            })

        # ê³ ê° ì„¸ê·¸ë¨¼íŠ¸ ë¶„ì„
        demo_cols = [col for col in df_all_join.columns if ('MAL' in col or 'FME' in col) and 'RAT' in col]
        area_detailed_profile = benchmark_df[demo_cols].mean()
        store_detailed_profile = store_df[demo_cols].mean()
        area_top2, store_top2 = area_detailed_profile.nlargest(2), store_detailed_profile.nlargest(2)

        match_score = calculate_advanced_match_score(area_top2.index.tolist(), store_top2.index.tolist())
        all_scores.append({
            'metric': 'ìƒê¶Œ-ê³ ê° ì í•©ë„', 
            'score': f"{match_score:.1f}ì ",
            'store_value_display': f"Top 2: {[n.replace('M12_','').replace('_RAT','') for n in store_top2.index.tolist()]}",
            'benchmark_value_display': f"Top 2: {[n.replace('M12_','').replace('_RAT','') for n in area_top2.index.tolist()]}",
            'raw_score': match_score,
            'higher_is_better': True
        })
        
        # ê°•ì ê³¼ ì•½ì  ë¶„ë¥˜
        strengths = [r for r in all_scores if float(r['score'].replace('ì ','')) > 80]
        weaknesses = [r for r in all_scores if (r['metric'] != 'ìƒê¶Œ-ê³ ê° ì í•©ë„' and float(r['score'].replace('ì ','')) < 20) or \
                                           (r['metric'] == 'ìƒê¶Œ-ê³ ê° ì í•©ë„' and float(r['score'].replace('ì ','')) < 40)]
        
        if not weaknesses and all_scores:
            weakest_link = min(all_scores, key=lambda x: float(x['score'].replace('ì ','')))
            weaknesses.append(weakest_link)
            
        # ì •ë ¬
        sorted_strengths = sorted(strengths, key=lambda x: float(x['score'].split('ì ')[0]), reverse=True)
        sorted_weaknesses = sorted(weaknesses, key=lambda x: float(x['score'].split('ì ')[0]))

        # 1. LLMì— ì „ë‹¬í•  ë°ì´í„° ì •ë¦¬
        # ë¦¬ìŠ¤íŠ¸ë¥¼ ë¬¸ìì—´ë¡œ ë³€í™˜
        def format_metric_list(metric_list):
            return "\n".join([
                f"- {item['metric']} (ê²½ì˜ ì ìˆ˜: {item['score']}): ìš°ë¦¬ ê°€ê²Œ({item['store_value_display']}) vs ê²½ìŸì ({item['benchmark_value_display']})" 
                for item in metric_list
            ])
            
        strengths_str = format_metric_list(sorted_strengths)
        weaknesses_str = format_metric_list(sorted_weaknesses)
        
        # 2. LLM í˜¸ì¶œì„ ìœ„í•œ í”„ë¡¬í”„íŠ¸ êµ¬ì„±
        # (ì´ í”„ë¡¬í”„íŠ¸ëŠ” Gemini 2.5 Flashë¥¼ ìœ„í•œ ê²ƒì…ë‹ˆë‹¤)
        llm_prompt = f"""
ë‹¹ì‹ ì€ 2025 ì‹ í•œì¹´ë“œ ë¹…ì½˜í…ŒìŠ¤íŠ¸ì˜ 'AI ë¹„ë°€ìƒë‹´ì‚¬'ì…ë‹ˆë‹¤. [cite: 2]
ë‹¹ì‹ ì˜ ì„ë¬´ëŠ” ì˜ì„¸/ì¤‘ì†Œ ìš”ì‹ ê°€ë§¹ì  ì ì£¼ì—ê²Œ [cite: 12, 14] ë°ì´í„°ë¥¼ ê¸°ë°˜ìœ¼ë¡œ [cite: 53] ì‹¤ì§ˆì ì¸ ë§ˆì¼€íŒ… ì „ëµì„ ì œì•ˆí•˜ëŠ” ê²ƒì…ë‹ˆë‹¤.

ì§€ê¸ˆë¶€í„° ë‹¤ìŒ ë°ì´í„°ë¥¼ ê¸°ë°˜ìœ¼ë¡œ 'ê²½ì˜ ë¶„ì„ ë¦¬í¬íŠ¸'ë¥¼ ì‘ì„±í•´ì£¼ì„¸ìš”.
ì ì£¼ê°€ ë°”ë¡œ ì´í•´í•˜ê³  ì‹¤í–‰í•  ìˆ˜ ìˆë„ë¡ [cite: 16] êµ¬ì²´ì ì´ê³  ì„¤ë“ë ¥ ìˆê²Œ ì‘ì„±í•´ì•¼ í•©ë‹ˆë‹¤.

[ê°€ë§¹ì  ê¸°ë³¸ ì •ë³´]
{basic_info_content}
ë¶„ì„ ê¸°ì¤€: {benchmark_type} (ìµœê·¼ 12ê°œì›” ë°ì´í„°)
ì—…ì¢…/ìƒê¶Œ: {category} / {commercial_area if pd.notna(commercial_area) else 'ë¹„ìƒê¶Œ'}

[ë¶„ì„ ê²°ê³¼: ê°•ì ]
{strengths_str if sorted_strengths else "íŠ¹ë³„í•œ ê°•ì ì´ ë°œê²¬ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤."}

[ë¶„ì„ ê²°ê³¼: ì•½ì ]
{weaknesses_str if sorted_weaknesses else "íŠ¹ë³„í•œ ì•½ì ì´ ë°œê²¬ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤."}

---
[ë¦¬í¬íŠ¸ ì‘ì„± ì§€ì‹œì‚¬í•­]

1.  **ğŸ“Š AI ì „ë°©ìœ„ ì§„ë‹¨ - '{store_id}' ê°€ë§¹ì  ë¦¬í¬íŠ¸**
    * (ì œê³µëœ [ê°€ë§¹ì  ê¸°ë³¸ ì •ë³´]ë¥¼ ì—¬ê¸°ì— ë¨¼ì € í¬í•¨í•˜ì„¸ìš”.)

2.  **ğŸ“ˆ ë¶„ì„ ê°œìš”**
    * (ì œê³µëœ 'ë¶„ì„ ê¸°ì¤€', 'ì—…ì¢…/ìƒê¶Œ' ì •ë³´ë¥¼ ì—¬ê¸°ì— í¬í•¨í•˜ì„¸ìš”.)

3.  **âœ… ê°•ì  ìš”ì•½ (Top 3)**
    * (ì œê³µëœ [ë¶„ì„ ê²°ê³¼: ê°•ì ] ëª©ë¡ì„ ì—¬ê¸°ì— í¬í•¨í•˜ì„¸ìš”.)

4.  **âŒ ì•½ì  ìš”ì•½ (Top 3)**
    * (ì œê³µëœ [ë¶„ì„ ê²°ê³¼: ì•½ì ] ëª©ë¡ì„ ì—¬ê¸°ì— í¬í•¨í•˜ì„¸ìš”.)

5.  **ğŸ“£ í•µì‹¬ ë¬¸ì œ ì§„ë‹¨**
    * [ì¤‘ìš”!] 'ì•½ì  ìš”ì•½'ì— ë‚˜ì—´ëœ **ëª¨ë“  ì•½ì ì„ ì¢…í•©ì ìœ¼ë¡œ ë¶„ì„**í•˜ì—¬ ì´ ê°€ë§¹ì ì´ ê²ªëŠ” **ê°€ì¥ ê·¼ë³¸ì ì¸ 'í•µì‹¬ ë¬¸ì œ'**ë¥¼ í•œ ë¬¸ë‹¨ìœ¼ë¡œ ëª…í™•í•˜ê²Œ ì§„ë‹¨í•´ì£¼ì„¸ìš”.
    * (ì˜ˆ: "ë‹¨ìˆœíˆ ì¬ë°©ë¬¸ìœ¨ì´ ë‚®ì€ ê²ƒì´ ë¬¸ì œê°€ ì•„ë‹ˆë¼, [ì•½ì  1]ê³¼ [ì•½ì  2]ê°€ ê²°í•©ë˜ì–´ [êµ¬ì²´ì ì¸ ë¬¸ì œ ìƒí™©]ì´ ë°œìƒí•˜ê³  ìˆìŠµë‹ˆë‹¤.")

6.  **ğŸ’¡ ê°•ì  ê¸°ë°˜ ë§ì¶¤í˜• ê°œì„  ì†”ë£¨ì…˜**
    * [ë§¤ìš° ì¤‘ìš”!] 'í•µì‹¬ ë¬¸ì œ ì§„ë‹¨'ì—ì„œ ë„ì¶œëœ ë¬¸ì œë¥¼ í•´ê²°í•˜ê¸° ìœ„í•´, **[ë¶„ì„ ê²°ê³¼: ê°•ì ]ì„ ì ê·¹ì ìœ¼ë¡œ í™œìš©**í•˜ëŠ” **êµ¬ì²´ì ì´ê³  ì‹¤í–‰ ê°€ëŠ¥í•œ ë§ˆì¼€íŒ… ì „ëµ**ì„ ì œì•ˆí•´ì£¼ì„¸ìš”.
    * 'ê°•ì ì„ í™œìš©í•˜ì—¬ ì•½ì ì„ ë³´ì™„'í•˜ëŠ” ì „ëµì´ì–´ì•¼ í•©ë‹ˆë‹¤. [cite: 57]
    * ì ì£¼ê°€ **'ë¬´ì—‡ì„, ì™œ, ì–´ë–»ê²Œ'** í•´ì•¼ í•˜ëŠ”ì§€ ëª…í™•íˆ ì•Œ ìˆ˜ ìˆë„ë¡ êµ¬ì²´ì ì¸ ì‹¤í–‰ ë°©ì•ˆì„ ì œì‹œí•´ì•¼ í•©ë‹ˆë‹¤. [cite: 16]
    * (ì˜ˆ: "[ê°•ì : 20ëŒ€ ì—¬ì„± ê³ ê° ë¹„ìœ¨ ë†’ìŒ]ì„ í™œìš©í•˜ì—¬ [ì•½ì : ê°ë‹¨ê°€ ë‚®ìŒ]ì„ ê°œì„ í•˜ê¸° ìœ„í•œ 'ì¸ìŠ¤íƒ€ê·¸ë¨ ê°ì„± ì„¸íŠ¸ ë©”ë‰´' ì¶œì‹œ ì „ëµ...")

7.  **ğŸ’¡ ì¦‰ì‹œ ì‹¤í–‰ ê°€ëŠ¥í•œ ì•¡ì…˜ í”Œëœ (1-4ì£¼)**
    * ìœ„ 'ê°œì„  ì†”ë£¨ì…˜'ì„ ë°”íƒ•ìœ¼ë¡œ, ì ì£¼ê°€ ë‹¹ì¥ 1ì£¼ì°¨ë¶€í„° 4ì£¼ì°¨ê¹Œì§€ ì‹¤í–‰í•  ìˆ˜ ìˆëŠ” **êµ¬ì²´ì ì¸ ì£¼ì°¨ë³„ ì•¡ì…˜ í”Œëœ**ì„ 2~3ê°€ì§€ ì œì•ˆí•´ì£¼ì„¸ìš”.
    * (ì˜ˆ: "1ì£¼ì°¨: [êµ¬ì²´ì  í™œë™ A]", "2-3ì£¼ì°¨: [êµ¬ì²´ì  í™œë™ B]"...)
"""
        
        # 3. LLM í˜¸ì¶œ ë° ê²°ê³¼ ë°˜í™˜
        final_report = call_gemini_llm(llm_prompt)
        # 2. í†µí•©ëœ ë¦¬í¬íŠ¸ í•˜ë‚˜ë§Œ ë°˜í™˜
        return final_report

    except Exception as e:
        import traceback
        error_details = traceback.format_exc()
        return f"""ğŸš¨ ì „ë°©ìœ„ ë¶„ì„ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.

**ì˜¤ë¥˜ ìƒì„¸ ì •ë³´:**
- ì˜¤ë¥˜ ìœ í˜•: {type(e).__name__}
- ì˜¤ë¥˜ ë©”ì‹œì§€: {str(e)}
- ê°€ë§¹ì  ID: {store_id}

**í•´ê²° ë°©ë²•:**
1. ê°€ë§¹ì  IDê°€ ì˜¬ë°”ë¥¸ì§€ í™•ì¸í•´ì£¼ì„¸ìš”
2. ë°ì´í„°ë² ì´ìŠ¤ì— í•´ë‹¹ ê°€ë§¹ì  ì •ë³´ê°€ ìˆëŠ”ì§€ í™•ì¸í•´ì£¼ì„¸ìš”
3. ë¬¸ì œê°€ ì§€ì†ë˜ë©´ ê´€ë¦¬ìì—ê²Œ ë¬¸ì˜í•´ì£¼ì„¸ìš”

**ê¸°ìˆ ì  ì„¸ë¶€ì‚¬í•­:**
{error_details}"""
        
# =============================================================================
##íŠ¹í™”ì§ˆë¬¸ ë„êµ¬
# =============================================================================

@tool
def floating_population_strategy_tool(store_id: str, df_all_join: pd.DataFrame, df_gender_age: pd.DataFrame, df_weekday_weekend: pd.DataFrame, df_timeband: pd.DataFrame) -> str:
    """
    [íŠ¹í™” ì§ˆë¬¸ 4ë²ˆ ëª¨ë¸]
    ì§€í•˜ì² ì—­ ì¸ê·¼ ê°€ë§¹ì ì˜ 'ì„ íƒì˜ì—­' ìœ ë™ì¸êµ¬ ë°ì´í„°(Long Format) 3ì¢…(ì„±ë³„ì—°ë ¹, ìš”ì¼(í‰ì¼/ì£¼ë§), ì‹œê°„ëŒ€)ì„ ì‹¬ì¸µ ë¶„ì„í•˜ì—¬,
    ì‹ ê·œ ë°©ë¬¸ê°ì„ ë‹¨ê³¨ë¡œ ì „í™˜í•˜ê¸° ìœ„í•œ 'ì¬ë°©ë¬¸ ìœ ë„ ì „ëµ'ì„ ì „ë¬¸ì ìœ¼ë¡œ ì œì•ˆí•˜ëŠ” ë„êµ¬.
    'ìœ ë™ì¸êµ¬', 'ì§€í•˜ì² ì—­', 'ì¶œí‡´ê·¼', 'ì¬ë°©ë¬¸ ìœ ë„' ê´€ë ¨ ì§ˆë¬¸ì— ì‚¬ìš©ëœë‹¤.
    
    Args:
        store_id: ë¶„ì„í•  ê°€ë§¹ì  ID
        df_all_join: ì „ì²´ JOIN ë°ì´í„° (ê°€ê²Œ ì •ë³´ ì¡°íšŒìš©)
        df_gender_age: ì„±ë³„ì—°ë ¹ëŒ€ë³„_ìœ ë™ì¸êµ¬_ì„ íƒì˜ì—­.csv (Long Format)
        df_weekday_weekend: ìš”ì¼ë³„_ìœ ë™ì¸êµ¬_ì„ íƒì˜ì—­.csv (Long Format)
        df_timeband: ì‹œê°„ëŒ€ë³„_ìœ ë™ì¸êµ¬_ì„ íƒì˜ì—­.csv (Long Format)
    
    Returns:
        LLMì´ ìƒì„±í•œ ì™„ì„±ëœ ë¶„ì„ ë¦¬í¬íŠ¸ ë¬¸ìì—´
    """
    try:
        # 1. ê³µí†µ í—¬í¼ í•¨ìˆ˜ í˜¸ì¶œ (ê¸°ë³¸ì •ë³´ ì¶œë ¥ì„ ìœ„í•´ basic_info_content ë‹¤ì‹œ ì‚¬ìš©)
        basic_info_content, latest_store_data = _get_store_basic_info(store_id, df_all_join)
        
        if latest_store_data is None:
            return basic_info_content # ì˜¤ë¥˜ ë©”ì‹œì§€ëŠ” ê·¸ëŒ€ë¡œ ë°˜í™˜

        # --- ë°ì´í„° íŒŒì‹± í•¨ìˆ˜ (Long Format ì „ìš©) ---

        # ë°ì´í„° í¬ë§·íŒ… ìœ í‹¸
        def fmt(x, digits=1):
            try:
                return f"{float(x):,.{digits}f}"
            except Exception:
                return str(x)

        # ì»¬ëŸ¼ëª… ì •ê·œí™”
        def normalize_columns(df: pd.DataFrame) -> pd.DataFrame:
            df = df.copy()
            def norm(s):
                return str(s).replace("\u3000", "").replace(" ", "").strip()
            df.columns = [norm(c) for c in df.columns]
            rename_map = {}
            # Long Format ì»¬ëŸ¼ëª… í†µì¼
            for c in df.columns:
                if c in ["ì§€í‘œ","í•­ëª©","ë¶„ë¥˜","êµ¬ë¶„ê°’","êµ¬ë¶„*","êµ¬ë¶„_"]:
                    rename_map[c] = "êµ¬ë¶„"
                elif c in ["ì¸êµ¬", "ì¸êµ¬ìˆ˜", "ìœ ë™ì¸êµ¬"]:
                    rename_map[c] = "ì¸êµ¬(ëª…)"
                elif c == "ìš”ì¼":
                    rename_map[c] = "ìš”ì¼"
                elif c == "ì‹œê°„ëŒ€":
                    rename_map[c] = "ì‹œê°„ëŒ€"
            if rename_map:
                df = df.rename(columns=rename_map)
            return df

        # Long Format CSVë¥¼ Dictë¡œ ë³€í™˜í•˜ëŠ” í—¬í¼
        def get_long_data_dict(df, key_col_candidates, val_col_candidates):
            df = normalize_columns(df)
            key_col = next((c for c in df.columns if c in key_col_candidates), df.columns[0])
            val_col = next((c for c in df.columns if c in val_col_candidates), df.columns[1])
            # [ìˆ˜ì •] errors='coerce'ë¥¼ ì¶”ê°€í•˜ì—¬ ìˆ«ìê°€ ì•„ë‹Œ ê°’(ì˜ˆ: 'ì„ íƒ ì˜ì—­')ì„ NaNìœ¼ë¡œ ì²˜ë¦¬
            return pd.to_numeric(df.set_index(key_col)[val_col], errors='coerce').dropna().to_dict()

        # ì‹œê°„ëŒ€ í‘œê¸°ë¥¼ í•œê¸€ë¡œ
        def format_time_idx_to_korean(idx):
            try:
                if '~' in idx and 'ì‹œ' in idx:
                    parts = idx.split('~')
                    start = parts[0]
                    end = parts[1].replace('ì‹œ', '')
                    if not start.endswith('ì‹œ'):
                        start += 'ì‹œ'
                    return f"{start}ë¶€í„° {end}ì‹œ"
                return idx
            except Exception:
                return idx

        # DATA_BLOCK ìƒì„± í•¨ìˆ˜ (Long Format íŒŒì‹±í•˜ë„ë¡ ì „ë©´ ìˆ˜ì •)
        def make_data_block(gender_age_df, weekday_weekend_df, timeband_df, shop_row) -> str:
            lines = []
            shop = shop_row.iloc[0].to_dict() if len(shop_row) else {}
            shop_name = shop.get("MCT_NM", "ê°€ê²Œëª… ë¯¸ìƒ")
            shop_addr = shop.get("MCT_BSE_AR", "ì£¼ì†Œ ë¯¸ìƒ")
            # [*** ì—¬ê¸°ë¥¼ ìˆ˜ì • ***] 'ì§€í•˜ì² ì—­' ëŒ€ì‹  'ìƒê¶Œ' ì»¬ëŸ¼ì„ ì‚¬ìš©
            shop_commercial_area = shop.get("HPSN_MCT_BZN_CD_NM", "ìƒê¶Œ ë¯¸ìƒ")
            shop_cat = shop.get("ì—…ì¢…_ì •ê·œí™”1", shop.get("ì—…ì¢…_ì •ê·œí™”2_ëŒ€ë¶„ë¥˜", "ì—…ì¢… ë¯¸ìƒ"))

            meta = [
                f"* **ê°€ë§¹ì  ID:** {store_id}",
                f"* **ì—…ì¢…:** {shop_cat} (ê°€ê²Œëª…: {shop_name})",
                f"* **ìœ„ì¹˜:** {shop_addr}",
                # [*** ì—¬ê¸°ë¥¼ ìˆ˜ì • ***] 'ì¸ê·¼ ì§€í•˜ì² ì—­' -> 'ìƒê¶Œ'ìœ¼ë¡œ í…ìŠ¤íŠ¸ ë³€ê²½
                f"* **ìƒê¶Œ:** {shop_commercial_area}",
            ]
            lines.append("\n".join(meta))
            
            try:
                ga_data = get_long_data_dict(gender_age_df, ['êµ¬ë¶„', 'í•­ëª©'], ['ì¸êµ¬(ëª…)'])
                ga_male = ga_data.get("ë‚¨ì„±", 0)
                ga_female = ga_data.get("ì—¬ì„±", 0)
                # 'ì¼ì¼' í‚¤ê°€ ì—†ì„ ìˆ˜ ìˆìœ¼ë¯€ë¡œ, ë‚¨+ì—¬ í•©ê³„ë¡œ ga_totalì„ ê³„ì‚°
                ga_total = ga_male + ga_female 
                lines.append(f"* **ì¼ í‰ê·  ìœ ë™ì¸êµ¬:** {fmt(ga_total,0)}ëª… (ë‚¨ì„± {fmt(ga_male,0)}ëª…, ì—¬ì„± {fmt(ga_female,0)}ëª…)")
            except Exception as e:
                lines.append(f"* **ì„±/ì—°ë ¹ ë°ì´í„°:** (íŒŒì‹± ì˜¤ë¥˜: {e})")
            
            # 'ìš”ì¼' (df_dayofweek) ë¶„ì„ ë¡œì§ ì•„ì˜ˆ ì‚­ì œ
            
            try:
                ww_data = get_long_data_dict(weekday_weekend_df, ['êµ¬ë¶„', 'í•­ëª©'], ['ì¸êµ¬(ëª…)'])
                # 'í‰ì¼' ë˜ëŠ” 'ì£¼ì¤‘' í‚¤ë¥¼ ëª¨ë‘ ì‹œë„
                wk_val = float(ww_data.get("í‰ì¼", ww_data.get("ì£¼ì¤‘", 0)))
                we_val = float(ww_data.get("ì£¼ë§", 0))
                compare_text = "ë§ìŒ" if we_val > wk_val else "ì ìŒ"
                if wk_val == we_val: compare_text = "ë¹„ìŠ·í•¨"
                lines.append(f"* **í‰ì¼/ì£¼ë§ ìœ ë™ì¸êµ¬:** ì£¼ë§ {fmt(we_val,0)}ëª…/ì¼, í‰ì¼ {fmt(wk_val,0)}ëª…/ì¼ (ì£¼ë§ì´ í‰ì¼ë³´ë‹¤ {compare_text})")
            except Exception as e:
                lines.append(f"* **í‰ì¼/ì£¼ë§ ë°ì´í„°:** (íŒŒì‹± ì˜¤ë¥˜: {e})")

            try:
                tb_data = get_long_data_dict(timeband_df, ['ì‹œê°„ëŒ€'], ['ì¸êµ¬(ëª…)'])
                s = pd.Series(tb_data).astype(float).sort_values(ascending=False)[:3]
                time_lines = [f"{format_time_idx_to_korean(idx)}({fmt(val,0)}ëª…)" for idx, val in s.items()]
                lines.append(f"* **ì£¼ìš” ìœ ë™ ì‹œê°„ëŒ€:** {', '.join(time_lines)}")
            except Exception as e:
                lines.append(f"* **ì‹œê°„ëŒ€ ë°ì´í„°:** (íŒŒì‹± ì˜¤ë¥˜: {e})")

            return "\n".join(lines)

        # ê°€ë§¹ì  ì •ë³´ ì¡°íšŒ
        shop_row = df_all_join[df_all_join["ENCODED_MCT"] == store_id]
        if shop_row.empty:
            return f"ğŸš¨ ë¶„ì„ ë¶ˆê°€: '{store_id}' ê°€ë§¹ì ì˜ ë°ì´í„°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."

        # --- SYSTEM_PROMPT ë° build_prompt í•¨ìˆ˜ ìˆ˜ì • ---
        
        # í”„ë¡¬í”„íŠ¸ ìˆ˜ì • (ì£¼ë§ íŠ¹ì„± ë¶„ì„ ë°©ì‹ì„ 'í‰ì¼ vs ì£¼ë§'ë¡œ ë³€ê²½)
        SYSTEM_PROMPT = """
ë„ˆëŠ” '{shop_cat}' ì—…ì¢… ì „ë¬¸ ìƒê¶Œ ë¶„ì„ê°€ì´ì ë§ˆì¼€íŒ… ì „ëµê°€ë‹¤.
ë„ˆì˜ ì„ë¬´ëŠ” '{shop_station}' ì—­ì„¸ê¶Œì˜ [DATA_BLOCK]ì„ ì‹¬ì¸µ ë¶„ì„í•˜ê³ , ìœ ë™ì¸êµ¬ë¥¼ 'ì¬ë°©ë¬¸ ë‹¨ê³¨'ë¡œ ë§Œë“¤ê¸° ìœ„í•œ ì°½ì˜ì ì´ê³  êµ¬ì²´ì ì¸ ì „ëµì„ ì œì•ˆí•˜ëŠ” ê²ƒì´ë‹¤.
ì¶”ìƒì ì¸ ì¡°ì–¸ì€ ê¸ˆì§€. [DATA_BLOCK]ì˜ ìˆ«ìë¥¼ ì§ì ‘ ì–¸ê¸‰í•˜ë©° ë°ì´í„°ì— ê¸°ë°˜í•œ ì „ëµë§Œ ì œì‹œí•˜ë¼.

[DATA_BLOCK]
{data_block}

[OUTPUT INSTRUCTION]
ì•„ë˜ 1ë²ˆ, 2ë²ˆ í•­ëª©ì„ ë°˜ë“œì‹œ í¬í•¨í•˜ì—¬ ë¦¬í¬íŠ¸ë¥¼ ì™„ì„±í•˜ë¼.

---
**1. {shop_station} ì¸ê·¼ ìœ ë™ì¸êµ¬ íŠ¹ì„± ë° ì¶œí‡´ê·¼ ì‹œê°„ëŒ€ ë³€í™” (ì‹¬ì¸µ ë¶„ì„)**
([DATA_BLOCK]ì„ ì‹¬ì¸µì ìœ¼ë¡œ ë¶„ì„í•˜ë¼.)

* **ì¶œê·¼ ì‹œê°„ (05ì‹œ~09ì‹œ):** ì´ ì‹œê°„ëŒ€ ìœ ë™ì¸êµ¬(ì•½ {morning_pop}ëª…)ëŠ” ì£¼ë¡œ ì§ì¥ì¸/í•™ìƒì¼ ê²ƒì´ë‹¤. ì´ë“¤ì˜ íŠ¹ì„±(ì˜ˆ: ë¹ ë¥¸ ì•„ì¹¨ ì‹ì‚¬, í…Œì´í¬ì•„ì›ƒ ì»¤í”¼)ì„ ì¶”ë¡ í•˜ê³ , í˜„ì¬ {shop_cat} ì—…ì¢…ê³¼ì˜ ì—°ê´€ì„±ì„ ë¶„ì„í•˜ë¼.
* **ì ì‹¬ ì‹œê°„ (09ì‹œ~14ì‹œ):** ì ì‹¬ì‹œê°„ëŒ€ ìœ ë™ì¸êµ¬(ì•½ {lunch_pop}ëª…)ëŠ” {shop_station} ì¸ê·¼ ì§ì¥ì¸ ìˆ˜ìš”ë¥¼ ì˜ë¯¸í•œë‹¤. ì´ ì‹œê°„ëŒ€ ì¸êµ¬ê°€ ë‹¤ë¥¸ ì‹œê°„ëŒ€ì— ë¹„í•´ ì–´ë–¤ ìˆ˜ì¤€ì¸ì§€ **ìˆ«ìë¥¼ ë“¤ì–´ ë¹„êµ**í•˜ê³ , {shop_cat} ì—…ì¢…ì— ì–´ë–¤ ê¸°íšŒê°€ ìˆëŠ”ì§€ ë¶„ì„í•˜ë¼.
* **í‡´ê·¼ ì‹œê°„ (18ì‹œ~23ì‹œ):** í‡´ê·¼ ì‹œê°„ëŒ€ ìœ ë™ì¸êµ¬(ì•½ {evening_pop}ëª…)ëŠ” ì´ ìƒê¶Œì˜ **í•µì‹¬ ì ì¬ ê³ ê°**ì´ë‹¤. ì´ ì¸êµ¬ê°€ í•˜ë£¨ ì¤‘ ê°€ì¥ ë§ì€ì§€(í˜¹ì€ ì ì€ì§€) **ìˆ«ìë¡œ ë¹„êµ**í•˜ê³ , ì´ë“¤ì´ ì›í•˜ëŠ” ê²ƒ(ì˜ˆ: ê°„ë‹¨í•œ ì‹ì‚¬, ë™ë£Œì™€ì˜ í•œì”)ì´ ë¬´ì—‡ì¼ì§€ {shop_cat} ì—…ì¢…ê³¼ ì—°ê²°í•˜ì—¬ ì¶”ë¡ í•˜ë¼.
* **ì£¼ë§ íŠ¹ì„± (í‰ì¼ vs ì£¼ë§):** ì£¼ë§ ìœ ë™ì¸êµ¬(ì•½ {weekend_pop}ëª…)ê°€ í‰ì¼(ì•½ {weekday_pop}ëª…) ëŒ€ë¹„ ì–´ë–¤ì§€ **ìˆ«ìë¡œ ë¹„êµ**í•˜ë¼. ì´ ë°ì´í„°ëŠ” {shop_station} ìƒê¶Œì´ 'ì˜¤í”¼ìŠ¤ ìƒê¶Œ'ì¸ì§€ 'ì£¼ë§ ë‚˜ë“¤ì´ ìƒê¶Œ'ì¸ì§€ íŒë‹¨í•  í•µì‹¬ ê·¼ê±°ë‹¤. ì´ê²ƒì´ {shop_cat} ì—…ì¢…ì˜ ì£¼ë§ ìš´ì˜ì— ì–´ë–¤ ì˜ë¯¸ë¥¼ ì£¼ëŠ”ì§€ ë¶„ì„í•˜ë¼.

---
**2. ì¬ë°©ë¬¸ ê³ ê° ìœ ë„ë¥¼ ìœ„í•œ ì§‘ì¤‘ ì „ëµ (ë°ì´í„° ê¸°ë°˜ ì œì•ˆ)**
(ì‹ ê·œ ìœ ë™ì¸êµ¬ë¥¼ ë‹¨ê³¨ë¡œ ì „í™˜í•˜ëŠ” ê²ƒì´ í•µì‹¬ ëª©í‘œë‹¤. ìœ„ 1ë²ˆ ë¶„ì„ê³¼ [DATA_BLOCK]ì„ ê·¼ê±°ë¡œ, **ì°½ì˜ì ì´ê³  êµ¬ì²´ì ì¸ ì „ëµ 3-4ê°€ì§€**ë¥¼ ì œì•ˆí•˜ë¼. 'ì´ìƒì ì¸ ì´ë¯¸ì§€'ì˜ ì˜ˆì‹œì²˜ëŸ¼ ìƒì„¸í•˜ê²Œ ì‘ì„±í•˜ë˜, **ì ˆëŒ€ í•˜ë“œì½”ë”©í•˜ì§€ ë§ê³  ë°ì´í„°ì— ë§ì¶° ìƒì„±**í•˜ë¼.)

**[ì „ëµ ì˜ˆì‹œ 1: {morning_pop}ëª…ì˜ ì¶œê·¼ ê³ ê° íƒ€ê²Ÿ ì „ëµ]** (â†ë°ì´í„°ì— ê·¼ê±°í•˜ì—¬ AIê°€ ì§ì ‘ ì†Œì œëª© ìƒì„±)
* **ì•„ì´ë””ì–´:** (ì˜ˆ: 'ë”¤ì„¬ ë¯¸ì‹ ì—¬ê¶Œ' ê°™ì€ ìŠ¤íƒ¬í”„/í¬ì¸íŠ¸ ì‹œìŠ¤í…œ ë„ì…)
* **êµ¬ì²´ì  ì‹¤í–‰ ë°©ì•ˆ:** (ì˜ˆ: 5íšŒ ë°©ë¬¸ ì‹œ ë©”ë‰´ 1ê°œ ë¬´ë£Œ, 10íšŒ ë°©ë¬¸ ì‹œ ì‹ì‚¬ê¶Œ 1ë§Œì› í• ì¸ ë“±...)
* **ë°ì´í„° ê·¼ê±°:** (ì˜ˆ: {shop_station} ì—­ì„¸ê¶Œì€ {total_pop}ëª…ì´ë¼ëŠ” ìœ ë™ì¸êµ¬ê°€ ìˆì§€ë§Œ ì¬ë°©ë¬¸ìœ¨ì´ ë‚®ë‹¤. ë”°ë¼ì„œ ëª…í™•í•œ ë³´ìƒ ì²´ê³„ë¡œ ì¬ë°©ë¬¸ ë™ê¸°ë¥¼ ë¶€ì—¬í•´ì•¼ í•œë‹¤...)

**[ì „ëµ ì˜ˆì‹œ 2: {evening_pop}ëª…ì˜ í‡´ê·¼ ê³ ê° íƒ€ê²Ÿ ì „ëµ]** (â†ë°ì´í„°ì— ê·¼ê±°í•˜ì—¬ AIê°€ ì§ì ‘ ì†Œì œëª© ìƒì„±)
* **ì•„ì´ë””ì–´:** (ì˜ˆ: 'í‡´ê·¼ í›„ ë”¤ë§¥ & ë§¥ì£¼' í”„ë¡œëª¨ì…˜)
* **êµ¬ì²´ì  ì‹¤í–‰ ë°©ì•ˆ:** (ì˜ˆ: ì˜¤í›„ 6ì‹œ~8ì‹œ ì‚¬ì´ 'ë”¤ì„¬ 2ì¢… + ìƒë§¥ì£¼ 2ì”' ì„¸íŠ¸ë¥¼ 2ë§Œì›ì— ì œê³µ...)
* **ë°ì´í„° ê·¼ê±°:** (ì˜ˆ: í•˜ë£¨ ì¤‘ ê°€ì¥ ë§ì€ {evening_pop}ëª…ì˜ ìœ ë™ì¸êµ¬ê°€ ëª°ë¦¬ëŠ” í‡´ê·¼ ì‹œê°„ëŒ€ì—, {shop_cat} ì—…ì¢…ì˜ íŠ¹ì„±ì„ ì‚´ë¦° 'í‡´ê·¼ê¸¸ ì¦ê±°ì›€'ì´ë¼ëŠ” ê²½í—˜ì„ ì œê³µí•˜ì—¬ ì¬ë°©ë¬¸ì„ ìœ ë„í•œë‹¤...)

**[ì „ëµ ì˜ˆì‹œ 3: {weekend_pop}ëª…ì˜ ì£¼ë§ ê³ ê° íƒ€ê²Ÿ ì „ëµ]** (â†ë°ì´í„°ì— ê·¼ê±°í•˜ì—¬ AIê°€ ì§ì ‘ ì†Œì œëª© ìƒì„±)
* **ì•„ì´ë””ì–´:** (ì˜ˆ: 'ì£¼ë§ ê°€ì¡±/ì—°ì¸ ì„¸íŠ¸' ë° SNS ì¸ì¦ ì´ë²¤íŠ¸)
* **êµ¬ì²´ì  ì‹¤í–‰ ë°©ì•ˆ:** (ì˜ˆ: 3-4ì¸ ê°€ì¡± ì„¸íŠ¸, 2ì¸ ì—°ì¸ ì„¸íŠ¸ êµ¬ì„±. ì¸ìŠ¤íƒ€ê·¸ë¨ì— íŠ¹ì • í•´ì‹œíƒœê·¸(#ëšì„¬ë§›ì§‘ #{shop_name}) ì¸ì¦ ì‹œ ìŒë£Œ 1ê°œ ë¬´ë£Œ ì œê³µ...)
* **ë°ì´í„° ê·¼ê±°:** (ì˜ˆ: ì£¼ë§ ìœ ë™ì¸êµ¬ê°€ {weekend_pop}ëª…ìœ¼ë¡œ í‰ì¼({weekday_pop}ëª…)ë³´ë‹¤ ë§ë‹¤ëŠ” ê²ƒì€, ì£¼ë§ ë‚˜ë“¤ì´/ë°ì´íŠ¸ ê³ ê°ì´ ë§ë‹¤ëŠ” ì˜ë¯¸ë‹¤. ì´ë“¤ì—ê²Œ 'ë©”ë‰´ ì„ íƒì˜ ê³ ë¯¼'ì„ ì¤„ì—¬ì£¼ê³  'SNS ì¸ì¦'ì˜ ì¦ê±°ì›€ì„ ì œê³µí•˜ì—¬...)
"""

        # build_prompt í•¨ìˆ˜: SYSTEM_PROMPTì— ë™ì  ë°ì´í„°ë¥¼ ì£¼ì…
        def build_prompt(data_block: str, shop_row, gender_age_df, weekday_weekend_df, timeband_df) -> str:
            
            shop_dict = shop_row.iloc[0].to_dict()
            
            try:
                ga_data = get_long_data_dict(gender_age_df, ['êµ¬ë¶„', 'í•­ëª©'], ['ì¸êµ¬(ëª…)'])
                ga_male = ga_data.get("ë‚¨ì„±", 0)
                ga_female = ga_data.get("ì—¬ì„±", 0)
                # 'ì¼ì¼' ëŒ€ì‹  í•©ê³„ ì‚¬ìš©
                ga_total = ga_male + ga_female
            except Exception:
                ga_data = {}
                ga_male = 0
                ga_female = 0
                ga_total = 0
            
            try:
                ww_data = get_long_data_dict(weekday_weekend_df, ['êµ¬ë¶„', 'í•­ëª©'], ['ì¸êµ¬(ëª…)'])
                # 'í‰ì¼' ë˜ëŠ” 'ì£¼ì¤‘' í‚¤ë¥¼ ëª¨ë‘ ì‹œë„
                wk_val = float(ww_data.get("í‰ì¼", ww_data.get("ì£¼ì¤‘", 0)))
                we_val = float(ww_data.get("ì£¼ë§", 0))
            except Exception:
                ww_data = {}
                wk_val = 0
                we_val = 0
            
            try:
                tb_data = get_long_data_dict(timeband_df, ['ì‹œê°„ëŒ€'], ['ì¸êµ¬(ëª…)'])
            except Exception:
                tb_data = {}

            # í”„ë¡¬í”„íŠ¸ í¬ë§·íŒ…ì— ì‚¬ìš©í•  ë”•ì…”ë„ˆë¦¬ ìƒì„±
            format_data = {
                "data_block": data_block,
                "shop_cat": shop_dict.get("ì—…ì¢…_ì •ê·œí™”1", "ìš”ì‹ì—…"),
                "shop_name": shop_dict.get("MCT_NM", "ìš°ë¦¬ ê°€ê²Œ"),
                # [*** ì—¬ê¸°ë¥¼ ìˆ˜ì • ***] 'ì§€í•˜ì² ì—­' ëŒ€ì‹  'ìƒê¶Œ' ì»¬ëŸ¼ì„ í”„ë¡¬í”„íŠ¸ì— ì£¼ì…
                "shop_station": shop_dict.get("HPSN_MCT_BZN_CD_NM", "í˜„ ìƒê¶Œ"),
                "total_pop": fmt(ga_total, 0), # í•©ê³„ total ì‚¬ìš©
                "morning_pop": fmt(tb_data.get("05~09ì‹œ", 0), 0),
                "lunch_pop": fmt(tb_data.get("09~12ì‹œ", 0) + tb_data.get("12~14ì‹œ", 0), 0),
                "evening_pop": fmt(tb_data.get("18~23ì‹œ", 0), 0),
                "weekday_pop": fmt(wk_val, 0), # ë¡œì§ì´ ì ìš©ëœ wk_val ì‚¬ìš©
                "weekend_pop": fmt(we_val, 0),
            }
            
            return SYSTEM_PROMPT.format(**format_data)

        # --- í•¨ìˆ˜ ë©”ì¸ ë¡œì§ ìˆ˜ì • (LLM ì§ì ‘ í˜¸ì¶œ) ---

        # ë°ì´í„° ë¸”ë¡ ìƒì„±
        # [ìˆ˜ì •] df_dayofweek ì œê±°
        data_block = make_data_block(df_gender_age, df_weekday_weekend, df_timeband, shop_row)
        
        # í”„ë¡¬í”„íŠ¸ ë¹Œë“œ (ë” ë§ì€ ì¸ì ì „ë‹¬)
        # [ìˆ˜ì •] df_dayofweek ì œê±°
        prompt = build_prompt(data_block, shop_row, df_gender_age, df_weekday_weekend, df_timeband)
        
        # LLM ì§ì ‘ í˜¸ì¶œ
        llm_response = call_gemini_llm(prompt)
        
        # ìµœì¢… í†µí•© ë¦¬í¬íŠ¸ ìƒì„±
        # 'ê¸°ë³¸ì •ë³´' ë‹¤ì‹œ ì¶”ê°€
        final_report = f"""
ğŸš‡ ìœ ë™ì¸êµ¬ ê¸°ë°˜ ì¬ë°©ë¬¸ ìœ ë„ ì „ëµ - '{store_id}' ê°€ë§¹ì  ë¶„ì„ ë¦¬í¬íŠ¸


{basic_info_content}

---
## ğŸ“Š ìœ ë™ì¸êµ¬ ë°ì´í„° ë¶„ì„ ë¦¬í¬íŠ¸
{data_block}

---
## ğŸ¤– AI ì»¨ì„¤í„´íŠ¸ ìƒì„¸ ì „ëµ ì œì•ˆ
{llm_response}
"""
        # 2. í†µí•©ëœ ë¦¬í¬íŠ¸ í•˜ë‚˜ë§Œ ë°˜í™˜
        return final_report

    except Exception as e:
        import traceback
        error_details = traceback.format_exc()
        return f"""ğŸš¨ ìœ ë™ì¸êµ¬ ì „ëµ ë¶„ì„ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.

**ì˜¤ë¥˜ ìƒì„¸ ì •ë³´:**
- ì˜¤ë¥˜ ìœ í˜•: {type(e).__name__}
- ì˜¤ë¥˜ ë©”ì‹œì§€: {str(e)}
- ê°€ë§¹ì  ID: {store_id}

**í•´ê²° ë°©ë²•:**
1. ê°€ë§¹ì  IDê°€ ì˜¬ë°”ë¥¸ì§€ í™•ì¸í•´ì£¼ì„¸ìš”
2. ë°ì´í„°ë² ì´ìŠ¤ì— í•´ë‹¹ ê°€ë§¹ì  ì •ë³´ê°€ ìˆëŠ”ì§€ í™•ì¸í•´ì£¼ì„¸ìš”
3. ë¬¸ì œê°€ ì§€ì†ë˜ë©´ ê´€ë¦¬ìì—ê²Œ ë¬¸ì˜í•´ì£¼ì„¸ìš”

**ê¸°ìˆ ì  ì„¸ë¶€ì‚¬í•­:**
{error_details}"""

@tool
def lunch_turnover_strategy_tool(store_id: str, df_all_join: pd.DataFrame, df_gender_age: pd.DataFrame, df_weekday_weekend: pd.DataFrame, df_dayofweek: pd.DataFrame, df_timeband: pd.DataFrame) -> str:
    """
    ì§ì¥ì¸ ìƒê¶Œì— ìœ„ì¹˜í•œ ê°€ë§¹ì ì˜ ë°ì´í„°ë¥¼ ë¶„ì„í•˜ì—¬, ì ì‹¬ í”¼í¬íƒ€ì„ì˜ 'íšŒì „ìœ¨'ì„ ê·¹ëŒ€í™”í•˜ê¸° ìœ„í•œ êµ¬ì²´ì ì¸ ìš´ì˜ ì „ëµì„ ì œì•ˆí•˜ëŠ” ë„êµ¬.
    'ì§ì¥ì¸', 'ì ì‹¬ì‹œê°„', 'íšŒì „ìœ¨', 'íš¨ìœ¨' ê´€ë ¨ ì§ˆë¬¸ì— ì‚¬ìš©ëœë‹¤.
    
    Args:
        store_id: ë¶„ì„í•  ê°€ë§¹ì  ID
        df_all_join: ì „ì²´ JOIN ë°ì´í„°
        df_gender_age: ì„±ë³„ì—°ë ¹ëŒ€ë³„ ìœ ë™ì¸êµ¬ ë°ì´í„°
        df_weekday_weekend: ìš”ì¼ë³„ ìœ ë™ì¸êµ¬ ë°ì´í„°
        df_dayofweek: ìš”ì¼ë³„ ìœ ë™ì¸êµ¬ ë°ì´í„°
        df_timeband: ì‹œê°„ëŒ€ë³„ ìœ ë™ì¸êµ¬ ë°ì´í„°
    
    Returns:
        LLMì´ ìƒì„±í•œ ì™„ì„±ëœ ë¶„ì„ ë¦¬í¬íŠ¸ ë¬¸ìì—´
    """
    try:
        # 1. ê³µí†µ í—¬í¼ í•¨ìˆ˜ í˜¸ì¶œ (ë°˜í™˜ ë³€ìˆ˜ëª… ë³€ê²½)
        basic_info_content, latest_store_data = _get_store_basic_info(store_id, df_all_join)
        
        if latest_store_data is None:
            return basic_info_content # ì˜¤ë¥˜ ë©”ì‹œì§€ëŠ” ê·¸ëŒ€ë¡œ ë°˜í™˜

        # ë°ì´í„° ë„ìš°ë¯¸ í•¨ìˆ˜
        def fmt(x, digits=1):
            try:
                return f"{float(x):,.{digits}f}"
            except Exception:
                return str(x)

        # DATA_BLOCK ìƒì„± í•¨ìˆ˜
        def make_data_block(monthly, gender_age, weekday_weekend, dayofweek, timeband, shop_row) -> str:
            lines = []
            shop = shop_row.iloc[0].to_dict() if len(shop_row) else {}
            shop_name = shop.get("MCT_NM", "ê°€ê²Œëª… ë¯¸ìƒ")
            shop_addr = shop.get("MCT_BSE_AR", "ì£¼ì†Œ ë¯¸ìƒ")
            # [*** ì—¬ê¸°ë¥¼ ìˆ˜ì • ***] 'ì§€í•˜ì² ì—­' ëŒ€ì‹  'ìƒê¶Œ' ì»¬ëŸ¼ì„ ì‚¬ìš©í•˜ê³  ë³€ìˆ˜ëª…ì€ shop_stationì„(ë¥¼) shop_commercial_areaë¡œ ë³€ê²½
            shop_commercial_area = shop.get("HPSN_MCT_BZN_CD_NM", "ìƒê¶Œ ë¯¸ìƒ")
            shop_cat = shop.get("ì—…ì¢…_ì •ê·œí™”1", shop.get("ì—…ì¢…_ì •ê·œí™”2_ëŒ€ë¶„ë¥˜", "ì—…ì¢… ë¯¸ìƒ"))
            shop_month = shop.get("TA_YM", "NA")
            
            # ì‹œê°„ëŒ€ í‘œê¸°ë¥¼ í•œê¸€ë¡œ ë°”ê¿”ì£¼ëŠ” í—¬í¼ í•¨ìˆ˜ (ì—¬ê¸° ì¶”ê°€)
            def format_time_idx_to_korean(idx):
                try:
                    if '~' in idx and 'ì‹œ' in idx:
                        parts = idx.split('~')
                        start = parts[0]
                        end = parts[1].replace('ì‹œ', '')
                        if not start.endswith('ì‹œ'):
                            start += 'ì‹œ'
                        return f"{start}ë¶€í„° {end}ì‹œ" # ì˜ˆ: "18~23ì‹œ" -> "18ì‹œë¶€í„° 23ì‹œ"
                    return idx
                except Exception:
                    return idx # ì˜¤ë¥˜ ì‹œ ì›ë³¸ ë°˜í™˜

            # 'ë°ì´í„° ë¶„ì„ ìš”ì•½' ì„¹ì…˜ì— ë§ê²Œ í¬ë§· ë³€ê²½ (## SHOP ì œê±°, ë¶ˆë › í¬ì¸íŠ¸ ì‚¬ìš©)
            meta = [
                f"* **ê°€ë§¹ì  ID:** {store_id}", # store_id ì¶”ê°€
                f"* **ì—…ì¢…:** {shop_cat} (ê°€ê²Œëª…: {shop_name})",
                f"* **ìœ„ì¹˜:** {shop_addr}",
                # [*** ì—¬ê¸°ë¥¼ ìˆ˜ì • ***] 'ì¸ê·¼ ì§€í•˜ì² ì—­' -> 'ìƒê¶Œ'ìœ¼ë¡œ í…ìŠ¤íŠ¸ ë³€ê²½
                f"* **ìƒê¶Œ:** {shop_commercial_area}",
                f"* **ê¸°ì¤€ì›”:** {shop_month}",
            ]
            lines.append("\n".join(meta))

            # ì„±/ì—°ë ¹
            ga_row = gender_age.iloc[0]
            ga_total = ga_row.get("ì¼ì¼")
            ga_male = ga_row.get("ë‚¨ì„±")
            ga_female = ga_row.get("ì—¬ì„±")
            ga_lines = []
            if ga_total is not None:
                ga_lines.append(f"* **ì¼ í‰ê·  ìœ ë™ì¸êµ¬:** {fmt(ga_total,0)}ëª… (ë‚¨ì„± {fmt(ga_male,0)}ëª…, ì—¬ì„± {fmt(ga_female,0)}ëª…)")
            lines.append("\n".join(ga_lines) if ga_lines else "")

            # í‰/ì£¼ë§
            if "ì£¼ì¤‘" in weekday_weekend.columns:
                row = weekday_weekend[weekday_weekend["êµ¬ë¶„"] == "ì¸êµ¬"].iloc[0]
                wk_val = float(row['ì£¼ì¤‘'])
                we_val = float(row['ì£¼ë§'])
                wk = fmt(wk_val, 0)
                we = fmt(we_val, 0)
                
                compare_text = "ë§ìŒ" if wk_val > we_val else "ì ìŒ"
                if wk_val == we_val: compare_text = "ë¹„ìŠ·í•¨"
                
                lines.append(f"* **í‰ì¼/ì£¼ë§ ìœ ë™ì¸êµ¬:** í‰ì¼ {wk}ëª…/ì¼, ì£¼ë§ {we}ëª…/ì¼ (í‰ì¼ì´ ì£¼ë§ë³´ë‹¤ {compare_text})")
            else:
                lines.append("* **í‰ì¼/ì£¼ë§ ìœ ë™ì¸êµ¬:** ì •ë³´ ì—†ìŒ")

            # ì‹œê°„ëŒ€
            row = timeband[timeband["êµ¬ë¶„"] == "ì¸êµ¬"].iloc[0]
            # [ìˆ˜ì •] .astype(float) ì¶”ê°€
            top3_series = row[["05~09ì‹œ", "09~12ì‹œ", "12~14ì‹œ", "14~18ì‹œ", "18~23ì‹œ", "23~05ì‹œ"]].astype(float).sort_values(ascending=False)[:3]
            # í—¬í¼ í•¨ìˆ˜ ì ìš© ë° í¬ë§· ë³€ê²½
            time_lines = [f"{format_time_idx_to_korean(idx)}({fmt(val,0)}ëª…)" for idx, val in top3_series.items()]
            lines.append(f"* **ì£¼ìš” ìœ ë™ ì‹œê°„ëŒ€:** {', '.join(time_lines)}")
            
            # ìš”ì¼ (ì°¸ê³ ìš©ìœ¼ë¡œ ì¶”ê°€)
            if "ì›”" in dayofweek.columns:
                pop_row = dayofweek[dayofweek["êµ¬ë¶„"] == "ì¸êµ¬"].iloc[0]
                # [ìˆ˜ì •] .astype(float) ì¶”ê°€
                top2 = pop_row[["ì›”", "í™”", "ìˆ˜", "ëª©", "ê¸ˆ", "í† ", "ì¼"]].astype(float).sort_values(ascending=False)[:2]
                top_lines = [f"{idx}ìš”ì¼({fmt(val,0)}ëª…)" for idx, val in top2.items()]
                lines.append(f"* **ì£¼ìš” ìœ ë™ ìš”ì¼:** {', '.join(top_lines)}")

            return "\n".join(lines)

        # ê°€ë§¹ì  ì •ë³´ ì¡°íšŒ
        shop_row = df_all_join[df_all_join["ENCODED_MCT"] == store_id]
        if shop_row.empty:
            return f"ğŸš¨ ë¶„ì„ ë¶ˆê°€: '{store_id}' ê°€ë§¹ì ì˜ ë°ì´í„°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."

        # í”„ë¡¬í”„íŠ¸ êµ¬ì„±
        SYSTEM_PROMPT = """
ë„ˆëŠ” 'ë°±ë°˜/ê°€ì •ì‹' ì—…ì¢… ì „ë¬¸ ì™¸ì‹ ì»¨ì„¤í„´íŠ¸ë‹¤.
ë„ˆì˜ ì„ë¬´ëŠ” ì‚¬ì¥ë‹˜ì—ê²Œ [DATA_BLOCK]ì„ ê·¼ê±°ë¡œ ì ì‹¬ì‹œê°„ 'íšŒì „ìœ¨'ì„ ê·¹ëŒ€í™”í•  êµ¬ì²´ì ì´ê³  ë…ì°½ì ì¸ ì•¡ì…˜ í”Œëœì„ ì œì‹œí•˜ëŠ” ê²ƒì´ë‹¤.
ì¶”ìƒì ì¸ ì¡°ì–¸('ì—´ì‹¬íˆ í•˜ì„¸ìš”', 'í™ë³´í•˜ì„¸ìš”')ì€ ì ˆëŒ€ ê¸ˆì§€. [DATA_BLOCK]ì˜ ìˆ«ìë¥¼ ì§ì ‘ ì–¸ê¸‰í•˜ë©° ë°ì´í„°ì— ê¸°ë°˜í•œ ì „ëµë§Œ ì œì‹œí•˜ë¼.

[DATA_BLOCK]
{data_block}

[OUTPUT INSTRUCTION]
ì•„ë˜ 1ë²ˆ, 2ë²ˆ í•­ëª©ì„ ë°˜ë“œì‹œ í¬í•¨í•˜ì—¬ ë¦¬í¬íŠ¸ë¥¼ ì™„ì„±í•˜ë¼.

---
**1) ì ì‹¬ì‹œê°„ ì§ì¥ì¸êµ¬ íŠ¹ì„± ìš”ì•½ (ì‹¬ì¸µ ë¶„ì„)**
([DATA_BLOCK]ì˜ ë°ì´í„°ë¥¼ ì‹¬ì¸µì ìœ¼ë¡œ ë¶„ì„í•˜ë¼.)

* **í‰ì¼ vs ì£¼ë§ ë¶„ì„:** í‰ì¼ ìœ ë™ì¸êµ¬(ì˜ˆ: {wk}ëª…)ì™€ ì£¼ë§ ìœ ë™ì¸êµ¬(ì˜ˆ: {we}ëª…)ë¥¼ **ìˆ«ìë¡œ ì§ì ‘ ë¹„êµ**í•˜ë¼. ì´ ì°¨ì´ê°€ 'ì§ì¥ì¸ ìƒê¶Œ'ì´ë¼ëŠ” ê°€ê²Œ íŠ¹ì„±ê³¼ ë§ëŠ”ì§€, í˜¹ì€ ì£¼ë§ì— ë‹¤ë¥¸ ê¸°íšŒê°€ ìˆëŠ”ì§€ ë¶„ì„í•˜ë¼.
* **ì‹œê°„ëŒ€ë³„ ì‹¬ì¸µ ë¶„ì„:** ì ì‹¬ í”¼í¬ ì‹œê°„ëŒ€(ì˜ˆ: 09ì‹œ~12ì‹œ ë˜ëŠ” 12ì‹œ~14ì‹œ)ì˜ ìœ ë™ì¸êµ¬ë¥¼ **ìˆ«ìë¡œ ì–¸ê¸‰**í•˜ë©°, ì €ë… ë“± ë‹¤ë¥¸ í”¼í¬ ì‹œê°„ëŒ€(ì˜ˆ: 18ì‹œ~23ì‹œ)ì™€ **ìˆ«ìë¡œ ë¹„êµ**í•˜ë¼. ì ì‹¬ ìœ ë™ì¸êµ¬ê°€ ìƒëŒ€ì ìœ¼ë¡œ ì ë‹¤ë©´(í˜¹ì€ ë§ë‹¤ë©´) ì´ê²ƒì´ ì‚¬ì¥ë‹˜ì—ê²Œ ì–´ë–¤ ì˜ë¯¸(ìœ„ê¸°/ê¸°íšŒ)ì¸ì§€ í•´ì„í•˜ë¼.
* **ê³ ê° ì„±ë³„ ë¶„ì„:** ë‚¨ì„±(ì˜ˆ: {male}ëª…)ê³¼ ì—¬ì„±(ì˜ˆ: {female}ëª…) ë¹„ìœ¨ì„ **ìˆ«ìë¡œ ë¹„êµ**í•˜ë¼. ì´ ì„±ë¹„ê°€ ë°±ë°˜/ê°€ì •ì‹ ì—…ì¢…ì˜ ì£¼ íƒ€ê²Ÿ(ì˜ˆ: ë¹ ë¥¸ í•œ ë¼ë¥¼ ì›í•˜ëŠ” ë‚¨ì„± ì§ì¥ì¸)ê³¼ ì¼ì¹˜í•˜ëŠ”ì§€, ì´ë“¤ì´ ë¬´ì—‡ì„ ì„ í˜¸í• ì§€ **ë°ì´í„°ì— ê·¼ê±°í•˜ì—¬ ì¶”ë¡ **í•˜ë¼.
* **ì¢…í•© ê²°ë¡ :** ìœ„ 3ê°€ì§€ ë¶„ì„ì„ í† ëŒ€ë¡œ, ì‚¬ì¥ë‹˜ì´ ì¸ì§€í•´ì•¼ í•  'ìš°ë¦¬ ê°€ê²Œ ì ì‹¬ ê³ ê°'ì˜ í•µì‹¬ í”„ë¡œí•„ì„ 1-2ë¬¸ì¥ìœ¼ë¡œ ìµœì¢… ì •ì˜í•˜ë¼.

---
**2) ì ì‹¬ í”¼í¬íƒ€ì„ íšŒì „ìœ¨ ê·¹ëŒ€í™” ì „ëµ (ë°ì´í„° ê¸°ë°˜ ì œì•ˆ)**
(ë°±ë°˜ì§‘ì˜ í•µì‹¬ KPIëŠ” 'íšŒì „ìœ¨'ì„ì„ ëª…ì‹¬í•˜ê³ , ì•„ë˜ 4ê°€ì§€ ì¹´í…Œê³ ë¦¬ì— ë§ì¶° **[DATA_BLOCK]ì˜ ë°ì´í„°ë¥¼ ê·¼ê±°ë¡œ** êµ¬ì²´ì ì¸ ì „ëµì„ ì œì•ˆí•˜ë¼. ì ˆëŒ€ë¡œ ì •í•´ì§„ ë‹µë³€ì„ í•˜ì§€ ë§ê³  ë°ì´í„°ì— ë§ì¶° ì°½ì˜ì ìœ¼ë¡œ ì œì•ˆí•˜ë¼.)

**1. ë©”ë‰´ ì „ëµ (Menu Simplification)**
* **ì „ëµ:** [DATA_BLOCK]ì˜ **ê³ ê° íŠ¹ì„±(ì˜ˆ: ë‚¨/ì—¬ ë¹„ìœ¨, í‰ì¼/ì£¼ë§ ì°¨ì´)**ì„ ê·¼ê±°ë¡œ, ê°€ì¥ íš¨ê³¼ì ì¸ ì ì‹¬ ë©”ë‰´ êµ¬ì„±ì„ ì œì•ˆí•˜ë¼. (ì˜ˆ: ë‹¨ì¼ íŠ¹ì„  ë©”ë‰´, 2-3ê°€ì§€ ì„ íƒ ë©”ë‰´ ë“±)
* **ê·¼ê±°:** ì™œ ì´ ë©”ë‰´ êµ¬ì„±ì´ [DATA_BLOCK]ì˜ ê³ ê°(ì˜ˆ: **ë‚¨ì„± {male}ëª…**ìœ¼ë¡œ ì—¬ì„±ì´ {female}ëª…ë³´ë‹¤ ë§ì•„... / **í‰ì¼ {wk}ëª…**ìœ¼ë¡œ ì£¼ë§ë³´ë‹¤ ì ì–´...)ì—ê²Œ ë§¤ë ¥ì ì´ë©° íšŒì „ìœ¨ì„ ë†’ì´ëŠ”ì§€ **ìˆ«ìë¥¼ ë“¤ì–´** ì„¤ëª…í•˜ë¼.

**2. ì£¼ë¬¸/ê²°ì œ ì‹œìŠ¤í…œ (Ordering/Payment Flow)**
* **ì „ëµ:** [DATA_BLOCK]ì˜ **í”¼í¬ ì‹œê°„ëŒ€(ì˜ˆ: '18ì‹œë¶€í„° 23ì‹œ({top1_pop}ëª…)')**ì˜ í˜¼ì¡ë„ë¥¼ ì ì‹¬ì‹œê°„ê³¼ ë¹„êµí•˜ì—¬, ì ì‹¬ì‹œê°„ì— ì ìš©í•  ê°€ì¥ íš¨ìœ¨ì ì¸ ì£¼ë¬¸/ê²°ì œ ë°©ì‹ì„ ì œì•ˆí•˜ë¼.
* **ê·¼ê±°:** ì´ ë°©ì‹ì´ ì–´ë–»ê²Œ ì£¼ë¬¸ ë³‘ëª©í˜„ìƒì„ í•´ê²°í•˜ê³ , ì§ì›ì´ **{shop_cat}** ì—…ì¢…ì˜ í•µì‹¬ì¸ í…Œì´ë¸” ì •ë¦¬/ë°˜ì°¬ ë¦¬í•„ì— ì§‘ì¤‘í•˜ê²Œ ë§Œë“œëŠ”ì§€ ì„¤ëª…í•˜ë¼.

**3. ì¢Œì„ ë°°ì¹˜ ë° ë™ì„  (Seating & Flow)**
* **ì „ëµ:** [DATA_BLOCK]ì˜ **ê³ ê° ì„±ë¹„(ë‚¨ì„± {male}ëª… vs ì—¬ì„± {female}ëª…)**ì™€ **ìƒê¶Œ(ì˜ˆ: {shop_station} ì¸ê·¼)** íŠ¹ì„±ì„ ê³ ë ¤í•  ë•Œ, 1ì¸/2ì¸/4ì¸ì„ì˜ ì´ìƒì ì¸ ë¹„ìœ¨ì„ ì œì•ˆí•˜ë¼. (ì˜ˆ: 1-2ì¸ì„ ë¹„ì¤‘ í™•ëŒ€, ë°”(Bar) ì¢Œì„ ë„ì… ë“±)
* **ê·¼ê±°:** ì´ ì¢Œì„ ë°°ì¹˜ê°€ ì–´ë–»ê²Œ 1ì¸ ê³ ê°(í˜¹ì€ 2ì¸ ê³ ê°)ì˜ ë¹ ë¥¸ ì‹ì‚¬ë¥¼ ìœ ë„í•˜ê³ , ì „ì²´ì ì¸ í…Œì´ë¸” íšŒì „ ì†ë„ë¥¼ ë†’ì´ëŠ”ì§€ ì„¤ëª…í•˜ë¼.

**4. íšŒì „ìœ¨ ì´‰ì§„ í”„ë¡œëª¨ì…˜ (Turnover Promotion)**
* **ì „ëµ:** [DATA_BLOCK]ì˜ **ë°ì´í„°(ì˜ˆ: ì ì‹¬ ìœ ë™ì¸êµ¬ê°€ {lunch_pop}ëª…ìœ¼ë¡œ ì €ë…ë³´ë‹¤ ì ìŒ / í‰ì¼ì´ ì£¼ë§ë³´ë‹¤ ì ìŒ)**ë¥¼ í™œìš©í•˜ì—¬, ê³ ê°ì˜ ìë°œì ì¸ ë¹ ë¥¸ ì‹ì‚¬ë¥¼ ìœ ë„í•˜ê±°ë‚˜ í˜¹ì€ ì ì‹¬ì‹œê°„ëŒ€ ë°©ë¬¸ì„ ìœ ë„í•  ì°½ì˜ì ì¸ í”„ë¡œëª¨ì…˜ 1ê°€ì§€ë¥¼ ì œì•ˆí•˜ë¼.
* **ê·¼ê±°:** ì´ í”„ë¡œëª¨ì…˜ì´ ì–´ë–»ê²Œ ê³ ê° ê²½í—˜ì„ í•´ì¹˜ì§€ ì•Šìœ¼ë©´ì„œ(ì˜¤íˆë ¤ ë§Œì¡±ë„ë¥¼ ë†’ì´ë©´ì„œ) í‰ê·  ì‹ì‚¬ ì‹œê°„ì„ ë‹¨ì¶•ì‹œí‚¤ê±°ë‚˜, í˜¹ì€ ê°€ì¥ í•œê°€í•œ ì‹œê°„ëŒ€ì˜ ë§¤ì¶œì„ ë³´ì™„í•  ìˆ˜ ìˆëŠ”ì§€ **ë°ì´í„°ì— ê¸°ë°˜í•˜ì—¬** ì„¤ëª…í•˜ë¼.
"""

        QUESTION = (
            "ìš°ë¦¬ ê°€ê²ŒëŠ” ì§ì¥ì¸ ê³ ê°ì´ ì£¼ìš” íƒ€ê²Ÿì´ë©°, ì ì‹¬ì‹œê°„ì— í•´ë‹¹í•˜ëŠ” ìœ ë™ì¸êµ¬ì™€ ì§ì¥ì¸êµ¬ì˜ ë¶„ì„ì„ ìƒì„¸íˆ ì„¤ëª…í•´ì¤˜.\n"
            "1) ì ì‹¬ì‹œê°„ ì§ì¥ì¸êµ¬ íŠ¹ì„±ì„ ìš”ì•½í•´ì¤˜\n"
            "2) ì ì‹¬ í”¼í¬íƒ€ì„ì— íšŒì „ìœ¨ì„ ë†’ì´ê¸° ìœ„í•œ ì „ëµì„ ì œì‹œí•´ì¤˜"
        )

        def build_prompt(question: str, data_block: str, shop_row, gender_age, weekday_weekend, timeband) -> str:
            # í”„ë¡¬í”„íŠ¸ì— ë™ì ìœ¼ë¡œ ë°ì´í„°ë¥¼ ì£¼ì…í•˜ê¸° ìœ„í•´ ë³€ìˆ˜ ì¶”ê°€
            
            # ë°ì´í„° ì¶”ì¶œ (ë°ì´í„°í”„ë ˆì„ì—ì„œ ì§ì ‘)
            ga_row = gender_age.iloc[0]
            ww_row = weekday_weekend[weekday_weekend["êµ¬ë¶„"] == "ì¸êµ¬"].iloc[0]
            tb_row = timeband[timeband["êµ¬ë¶„"] == "ì¸êµ¬"].iloc[0]
            shop_dict = shop_row.iloc[0].to_dict()

            # 'top1_pop' ê³„ì‚° ë²„ê·¸ ìˆ˜ì •
            time_cols = ["05~09ì‹œ", "09~12ì‹œ", "12~14ì‹œ", "14~18ì‹œ", "18~23ì‹œ", "23~05ì‹œ"]
            # tb_row[time_cols]ë¡œ ìˆ«ì ì»¬ëŸ¼ë§Œ ì„ íƒ -> astype(float)ë¡œ ë³€í™˜ -> ì •ë ¬ -> ì²«ë²ˆì§¸ ê°’(iloc[0]) ì¶”ì¶œ
            top1_val = tb_row[time_cols].astype(float).sort_values(ascending=False).iloc[0]

            # í”„ë¡¬í”„íŠ¸ í¬ë§·íŒ…ì— ì‚¬ìš©í•  ë”•ì…”ë„ˆë¦¬ ìƒì„±
            format_data = {
                "data_block": data_block,
                "wk": fmt(ww_row.get('ì£¼ì¤‘', 0), 0),
                "we": fmt(ww_row.get('ì£¼ë§', 0), 0),
                "male": fmt(ga_row.get('ë‚¨ì„±', 0), 0),
                "female": fmt(ga_row.get('ì—¬ì„±', 0), 0),
                "top1_pop": fmt(top1_val, 0), # ìˆ˜ì •ëœ top1_val ì‚¬ìš©
                "lunch_pop": fmt(pd.to_numeric(tb_row.get('09~12ì‹œ', 0)) + pd.to_numeric(tb_row.get('12~14ì‹œ', 0)), 0), # 09-14ì‹œ ì¸êµ¬ í•©ì‚° ë° ìˆ«ì ë³€í™˜
                "shop_cat": shop_dict.get("ì—…ì¢…_ì •ê·œí™”1", "ìš”ì‹ì—…"),
                # [*** ì—¬ê¸°ë¥¼ ìˆ˜ì • ***] 'ì§€í•˜ì² ì—­' ëŒ€ì‹  'ìƒê¶Œ' ì»¬ëŸ¼ì„ í”„ë¡¬í”„íŠ¸ì— ì£¼ì…
                "shop_station": shop_dict.get("HPSN_MCT_BZN_CD_NM", "í˜„ ìƒê¶Œ")
            }
            
            # .format()ì„ ì‚¬ìš©í•˜ì—¬ SYSTEM_PROMPTì— ë°ì´í„° ì£¼ì…
            return SYSTEM_PROMPT.format(**format_data)

        # ë°ì´í„° ë¸”ë¡ ìƒì„±
        monthly = pd.DataFrame()  # ì‚¬ìš© ì•ˆí•¨
        data_block = make_data_block(monthly, df_gender_age, df_weekday_weekend, df_dayofweek, df_timeband, shop_row)
        
        # í”„ë¡¬í”„íŠ¸ ë¹Œë“œ (ë” ë§ì€ ì¸ì ì „ë‹¬)
        prompt = build_prompt(QUESTION, data_block, shop_row, df_gender_age, df_weekday_weekend, df_timeband)
        
        # LLM ì§ì ‘ í˜¸ì¶œ
        llm_response = call_gemini_llm(prompt)
        
        # ìµœì¢… ë¦¬í¬íŠ¸ êµ¬ì„± ë³€ê²½
        final_report = f"""
  ì ì‹¬ì‹œê°„ íšŒì „ìœ¨ ê·¹ëŒ€í™” ì „ëµ - '{store_id}' ê°€ë§¹ì  ë¶„ì„ ë¦¬í¬íŠ¸

{basic_info_content}

---
## ğŸ“Š ìœ ë™ì¸êµ¬ ë°ì´í„° ë¶„ì„
{data_block}

---
## ğŸ¤– AI ì»¨ì„¤í„´íŠ¸ ìƒì„¸ ì „ëµ ì œì•ˆ
{llm_response}
"""
        # 2. í†µí•©ëœ ë¦¬í¬íŠ¸ í•˜ë‚˜ë§Œ ë°˜í™˜
        return final_report

    except Exception as e:
        import traceback
        error_details = traceback.format_exc()
        return f"""ğŸš¨ ì ì‹¬ì‹œê°„ íšŒì „ìœ¨ ì „ëµ ë¶„ì„ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.

**ì˜¤ë¥˜ ìƒì„¸ ì •ë³´:**
- ì˜¤ë¥˜ ìœ í˜•: {type(e).__name__}
- ì˜¤ë¥˜ ë©”ì‹œì§€: {str(e)}
- ê°€ë§¹ì  ID: {store_id}

**í•´ê²° ë°©ë²•:**
1. ê°€ë§¹ì  IDê°€ ì˜¬ë°”ë¥¸ì§€ í™•ì¸í•´ì£¼ì„¸ìš”
2. ë°ì´í„°ë² ì´ìŠ¤ì— í•´ë‹¹ ê°€ë§¹ì  ì •ë³´ê°€ ìˆëŠ”ì§€ í™•ì¸í•´ì£¼ì„¸ìš”
3. ë¬¸ì œê°€ ì§€ì†ë˜ë©´ ê´€ë¦¬ìì—ê²Œ ë¬¸ì˜í•´ì£¼ì„¸ìš”

**ê¸°ìˆ ì  ì„¸ë¶€ì‚¬í•­:**
{error_details}"""